<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¡ƒåœ’119å¤§è»ŠéšŠå¤–é€ç¾å ´æ”»ç•¥ v8.0 (å¤–éƒ¨è®€å–ç‰ˆ)</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="119æ”»ç•¥">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">

    <!-- App Icon -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/roygemini9527/EMS/ee1e9df4074200e2c03b07974d87d74a9af0926c/LOGO.png">
    <link rel="icon" type="image/png" sizes="any" href="https://raw.githubusercontent.com/roygemini9527/EMS/ee1e9df4074200e2c03b07974d87d74a9af0926c/LOGO.png">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/roygemini9527/EMS/ee1e9df4074200e2c03b07974d87d74a9af0926c/LOGO.png">
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E6%A1%83%E5%9C%92119%E6%94%BB%E7%95%A5%22%2C%22short_name%22%3A%22119%E6%94%BB%E7%95%A5%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23111827%22%2C%22theme_color%22%3A%22%231f2937%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fraw.githubusercontent.com%2Froygemini9527%2FEMS%2Fee1e9df4074200e2c03b07974d87d74a9af0926c%2FLOGO.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

    <style>
        /* Base Styles */
        :root { --primary: #dc2626; --primary-dark: #991b1b; --bg-dark: #111827; --bg-card: #1f2937; --text-main: #f3f4f6; --text-sub: #9ca3af; --accent-p: #f59e0b; --success: #10b981; --info: #3b82f6; --ai-color: #8b5cf6; --border: #374151; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 100px; line-height: 1.6; -webkit-user-select: none; user-select: none; }
        
        /* Header */
        header { background-color: rgba(31, 41, 55, 0.98); padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); transition: top 0.3s ease-in-out; }
        header.nav-up { top: -150px; }
        h1 { font-size: 1.25rem; margin: 0 0 10px 0; color: #fca5a5; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px; text-align: center; }
        .version-tag { font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 12px; color: var(--text-sub); }
        .controls-row { display: flex; gap: 8px; position: relative; }
        .guide-btn { flex: 0 0 20%; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); color: var(--info); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        .search-input { flex: 1; background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 10px; font-size: 16px; transition: all 0.2s; }
        .search-input:focus { border-color: var(--accent-p); outline: none; background: #1a1a1a; }

        /* Guide Panel */
        .guide-panel { position: absolute; top: 110%; left: 0; width: 100%; background: var(--bg-card); border: 1px solid var(--info); border-radius: 10px; padding: 16px; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.9); display: none; max-height: 80vh; overflow-y: auto; }
        .guide-panel.open { display: block; }
        .guide-panel h3 { color: var(--info); margin-top: 0; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 8px; }
        .guide-panel p { font-size: 0.95rem; color: #d1d5db; margin-bottom: 12px; }
        
        /* Tabs */
        .nav-tabs { display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px; background: var(--bg-dark); border-bottom: 1px solid var(--border); position: sticky; top: 115px; z-index: 40; transition: top 0.3s ease-in-out; }
        header.nav-up + .nav-tabs { top: 0; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-sub); padding: 8px 16px; border-radius: 20px; font-size: 0.95rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 0 10px rgba(220, 38, 38, 0.4); }
        .tab-btn.ai-tab { border-color: var(--ai-color); color: var(--ai-color); }
        .tab-btn.ai-tab.active { background: var(--ai-color); color: white; box-shadow: 0 0 10px rgba(139, 92, 246, 0.4); }
        .tab-btn.p-mode.active { background: var(--accent-p); color: black; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }

        /* Cards */
        .container { padding: 16px; max-width: 800px; margin: 0 auto; }
        .card { background: var(--bg-card); border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border); overflow: hidden; transition: transform 0.1s; }
        .card.p-highlight { border-left: 4px solid var(--accent-p); }
        .card.tut-highlight { border-left: 4px solid var(--info); }
        .card-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; min-height: 50px; background: linear-gradient(to right, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); }
        .card-title { font-weight: 700; font-size: 1.1rem; color: #fff; }
        .card-id { font-size: 0.75rem; color: var(--text-sub); background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 6px; margin-right: 10px; font-family: monospace; }
        .card-body { display: none; padding: 16px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.1); }
        .card.expanded .card-body { display: block; }
        .expand-icon { transition: transform 0.3s; color: var(--text-sub); }
        .card.expanded .expand-icon { transform: rotate(180deg); color: white; }

        /* Content Styling */
        p, li { color: #d1d5db; font-size: 0.95rem; line-height: 1.7; }
        strong { color: white; }
        .sec-header { display: flex; align-items: center; gap: 8px; margin: 20px 0 10px 0; color: var(--primary-light); font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        
        /* Flowchart & Tags */
        .flow-container { display: flex; flex-direction: column; gap: 12px; margin: 16px 0; padding-left: 10px; border-left: 2px solid var(--border); }
        .flow-step { background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 12px; border-radius: 0 8px 8px 0; position: relative; font-size: 0.95rem; }
        .flow-step::before { content: ""; position: absolute; left: -12px; top: 50%; width: 10px; height: 2px; background: var(--border); }
        .tag-block { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 6px; font-weight: bold; }
        .tag-red { background: rgba(220, 38, 38, 0.2); color: #fca5a5; border: 1px solid #dc2626; }
        .tag-blue { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid #3b82f6; }
        .tag-green { background: rgba(16, 185, 129, 0.2); color: #86efac; border: 1px solid #10b981; }
        .tag-orange { background: rgba(249, 115, 22, 0.2); color: #fdba74; border: 1px solid #f97316; }

        /* TP & Drug Cards */
        .drug-box { background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 8px; padding: 14px; margin-top: 16px; }
        .drug-title { color: var(--accent-p); font-weight: 800; font-size: 1.1rem; border-bottom: 1px solid rgba(245, 158, 11, 0.2); padding-bottom: 8px; margin-bottom: 12px; }
        .tp-badge { background: var(--accent-p); color: black; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 8px; }
        .drug-card { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--accent-p); }
        .info-row { display: flex; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
        .info-row:last-child { border-bottom: none; }
        .info-label { width: 70px; color: var(--text-sub); font-size: 0.85rem; flex-shrink: 0; }
        .info-val { color: #f3f4f6; font-size: 0.95rem; font-weight: 500; }
        .info-val.danger { color: #fca5a5; } .info-val.success { color: #86efac; }

        /* AI Chat */
        .chat-wrapper { display: flex; flex-direction: column; height: calc(100vh - 180px); background: #1f2937; border-radius: 12px; border: 1px solid #374151; position: relative; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .message { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; user-select: text; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-ai { align-self: flex-start; background: #374151; color: #e5e7eb; border-bottom-left-radius: 4px; border-left: 3px solid var(--ai-color); }
        .chat-input-area { padding: 12px; background: rgba(0,0,0,0.3); border-top: 1px solid #374151; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px 16px; border-radius: 24px; border: 1px solid #4b5563; background: #111827; color: white; font-size: 16px; }
        .chat-send-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--ai-color); border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .chat-mic-btn { width: 44px; height: 44px; border-radius: 50%; background: #4b5563; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .chat-mic-btn.listening { background: #ef4444; animation: pulse 1.5s infinite; }
        
        .db-btn { display: inline-flex; align-items: center; margin-top: 10px; padding: 6px 12px; background: rgba(139, 92, 246, 0.15); border: 1px solid var(--ai-color); color: #c4b5fd; border-radius: 8px; font-size: 0.85rem; cursor: pointer; }
        .api-config-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.4); color: #9ca3af; border: 1px solid #4b5563; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; z-index: 10; }
        
        .fab { position: fixed; bottom: 30px; right: 24px; background-color: var(--accent-p); color: #000; width: 68px; height: 68px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 4px 20px rgba(0,0,0,0.5); cursor: pointer; z-index: 100; font-size: 1.4rem; border: 4px solid rgba(255,255,255,0.15); margin-bottom: env(safe-area-inset-bottom); }
        .fab span { font-size: 0.75rem; font-weight: normal; margin-top: -4px;}
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* KB Status Indicator */
        .kb-status { font-size: 0.7rem; color: #6b7280; text-align: center; margin-top: 4px; }
        .kb-status.loaded { color: var(--success); }
    </style>
</head>
<body>

<header>
    <h1>æ¡ƒåœ’119å¤§è»ŠéšŠå¤–é€ç¾å ´æ”»ç•¥ <span class="version-tag">v8.0</span></h1>
    <div class="controls-row">
        <div class="guide-btn" onclick="toggleGuide()">ğŸ“– èªªæ˜</div>
        <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœå°‹ï¼šOHCAã€ä¸­é¢¨ã€é‡å¤–...">
        <div class="guide-panel" id="guidePanel">
            <h3>ğŸ“– ä½¿ç”¨èªªæ˜ & AI æ•™å­¸</h3>
            <p><strong>âœ¨ AI åŠ©æ‰‹æ“ä½œ (é‡é»)ï¼š</strong></p>
            <ul>
                <li><strong>1. æ¨™æº–å›ç­”ï¼š</strong> AI æœƒå„ªå…ˆæ ¹æ“šæœ¬æ”»ç•¥çš„ã€Œæ¨™æº–æµç¨‹ã€å›ç­”ã€‚</li>
                <li><strong>2. ğŸ“š èª¿é–±è³‡æ–™åº« (è‡ªè¨‚çŸ¥è­˜åº«)ï¼š</strong> 
                    <br>ç‚ºäº†åŠ å¿«ç¨‹å¼é‹ä½œï¼Œè«‹å°‡æ‰‹å†Šå…§å®¹å­˜ç‚º <strong>manual.txt</strong> ä¸¦æ”¾åœ¨ç›¸åŒç›®éŒ„ä¸‹ã€‚
                    <br>ç•¶çœ‹åˆ°ã€Œâœ… KB: å·²è¼‰å…¥ã€æ™‚ï¼ŒAI æ‰èƒ½ç²¾ç¢ºå¼•ç”¨æ‰‹å†Šé æ•¸èˆ‡å…§å®¹ã€‚
                </li>
            </ul>
            <p><strong>å…¶ä»–åŠŸèƒ½ï¼š</strong></p>
            <ul>
                <li><strong>TP æ¨¡å¼ï¼š</strong>é»æ“Šå³ä¸‹è§’é»ƒè‰²æŒ‰éˆ•ï¼Œåˆ‡æ›é«˜ç´šæ•‘è­·å“¡æ¨¡å¼ã€‚ç³»çµ±æœƒè‡ªå‹•å°‡<strong>ã€ŒOHCAã€èƒ¸ç—›ã€è‚ºæ°´è…«ã€æ°£å–˜ã€</strong>ç½®é ‚ã€‚</li>
            </ul>
            <div style="text-align:right; margin-top:20px; color:var(--info); cursor:pointer; font-weight:bold;" onclick="toggleGuide()">[é—œé–‰èªªæ˜]</div>
        </div>
    </div>
</header>

<div class="nav-tabs">
    <div class="tab-btn active" onclick="filterCat('all')">å…¨è¦½</div>
    <div class="tab-btn ai-tab" onclick="filterCat('ai')">âœ¨ AI åŠ©æ‰‹</div>
    <div class="tab-btn p-mode" onclick="togglePMode()">TP å°ˆå€</div>
    <div class="tab-btn" onclick="filterCat('general')">é€šç”¨</div>
    <div class="tab-btn" onclick="filterCat('airway')">å‘¼å¸é“</div>
    <div class="tab-btn" onclick="filterCat('medical')">å…§ç§‘</div>
    <div class="tab-btn" onclick="filterCat('trauma')">å‰µå‚·</div>
    <div class="tab-btn" onclick="filterCat('special')">ç‰¹æ®Š</div>
    <div class="tab-btn tutorial" onclick="filterCat('tutorial')">ğŸ“± æ‰‹æ©Ÿå®‰è£æ•™å­¸</div>
</div>

<div class="container" id="contentArea"></div>
<div class="fab" onclick="togglePMode()" id="fabBtn">TP<span>æ¨¡å¼</span></div>

<script>
    // ==========================================
    // ğŸš€ è³‡æ–™åº«å„ªåŒ–å€ (Knowledge Base Optimization)
    // è¦å‰‡ï¼šå„ªå…ˆå¾å¤–éƒ¨ manual.txt è®€å–ã€‚
    // ==========================================
    let custom_kb = ""; 
    const KB_FILE_URL = "./manual.txt"; // è«‹ç¢ºä¿æ­¤æª”æ¡ˆå­˜åœ¨æ–¼ç›¸åŒç›®éŒ„

    async function loadKnowledgeBase() {
        try {
            const response = await fetch(KB_FILE_URL);
            if (!response.ok) throw new Error("File not found");
            custom_kb = await response.text();
            console.log("âœ… æˆåŠŸè¼‰å…¥å¤–éƒ¨æ‰‹å†Šè³‡æ–™åº«");
            const statusEl = document.querySelector('.kb-status');
            if(statusEl) {
                statusEl.textContent = "âœ… KB: å·²è¼‰å…¥ (å¯æŸ¥é–±è©³ç´°æ‰‹å†Š)";
                statusEl.classList.add('loaded');
            }
        } catch (error) {
            console.warn("âš ï¸ ç„¡æ³•è¼‰å…¥ manual.txtã€‚");
            const statusEl = document.querySelector('.kb-status');
            if(statusEl) {
                statusEl.textContent = "âš ï¸ KB: æœªè¼‰å…¥ (è«‹ç¢ºèª manual.txt å­˜åœ¨)";
            }
        }
    }
    
    // åˆå§‹åŒ–è¼‰å…¥
    loadKnowledgeBase();
    // ==========================================

    function toggleGuide() {
        const panel = document.getElementById('guidePanel');
        panel.classList.toggle('open');
    }

    let lastScrollTop = 0;
    const header = document.querySelector('header');
    window.addEventListener('scroll', function() {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop > lastScrollTop && scrollTop > 100) header.classList.add('nav-up');
        else header.classList.remove('nav-up');
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }, false);

    const protocols = [
        {
            id: "G-1", cat: "general", title: "é€šç”¨ä¸€ï¼šç·Šæ€¥æ•‘è­·ç¾å ´é€šç”¨æµç¨‹",
            flow: ["åˆ°é”ç¾å ´ -> åœè»Šæ–¼å®‰å…¨ä½ç½®", "å®‰å…¨è©•ä¼° (3S)", "è‡ªæˆ‘ä¿è­· (BSI)", "åˆ¤æ–·æ˜¯å¦éœ€æ”¯æ´", "åˆ¤æ–·æ¡ˆä»¶å±¬æ€§"],
            key: ["<strong>ç¾å ´å®‰å…¨ (3S)</strong> æ˜¯æ‰€æœ‰æ•‘è­·åŸºç¤ã€‚è‹¥æœ‰æš´åŠ›/åŒ–å­¸/ç«ç½é¢¨éšªï¼Œæ‡‰æ’¤é€€ä¸¦è«‹æ±‚æ”¯æ´ã€‚", "<strong>MCI å•Ÿå‹•ï¼š</strong>å‚·ç—…æ‚£ >15 äººæˆ–å±æ€¥ >5 äººã€‚", "<strong>æ„ŸæŸ“æ§åˆ¶ï¼š</strong>æ¥è§¸ç–‘ä¼¼å‚³æŸ“ç—…æ‚£æ‡‰å‡ç´šé˜²è­·ã€‚"],
            tp: null
        },
        {
            id: "G-2", cat: "general", title: "é€šç”¨äºŒï¼šéå‰µå‚·ç¾å ´æµç¨‹",
            flow: ["æ„è­˜è©•ä¼° (AVPU/GCS)", "ABCDE åˆæ­¥è©•ä¼°", "ç—…å²è©¢å• (SAMPLE)", "ç”Ÿå‘½å¾µè±¡é‡æ¸¬", "å±æ€¥åº¦åˆ¤æ–·"],
            key: ["<strong>æ„è­˜èˆ‡å‘¼å¸ï¼š</strong>æ„è­˜ä¸æ¸…ä¸”ç„¡é©ç•¶å‘¼å¸/è„ˆæ -> OHCAã€‚", "<strong>æ°§æ°£ç›®æ¨™ï¼š</strong>ä¸€èˆ¬ >94%ï¼›COPD 88-92%ã€‚", "<strong>å¾ªç’°ï¼š</strong>æ‘¸ä¸åˆ°æ©ˆå‹•è„ˆæš—ç¤º SBP < 80 mmHgã€‚"],
            tp: null
        },
        {
            id: "G-3", cat: "general", title: "é€šç”¨ä¸‰ï¼šå‰µå‚·ç¾å ´æµç¨‹",
            flow: ["é ¸æ¤é™åˆ¶ (SMR) åˆ¤æ–·", "X (å¤§å‡ºè¡€) -> ABC", "å¿«é€Ÿå‰µå‚·è©•ä¼°", "è‡´å‘½å‚·è™•ç½®", "ä¸Šé•·èƒŒæ¿/KED"],
            key: ["<strong>é ¸æ¤é™åˆ¶ï¼š</strong>é«˜èƒ½é‡æ©Ÿè½‰ã€æ˜è¿·ã€é ¸èƒŒç—›ã€ç¥ç¶“å­¸ç•°å¸¸ -> éœ€ä¸Šé ¸åœˆã€‚", "<strong>X (å¤§å‡ºè¡€)ï¼š</strong>å‹•è„ˆå™´å°„å‡ºè¡€ -> å„ªå…ˆä½¿ç”¨æ­¢è¡€å¸¶ (CAT) ç¶æ–¼å‚·å£è¿‘ç«¯ 5-8cmã€‚"],
            tp: null
        },
        {
            id: "Med-1", cat: "medical", title: "éå‰µå‚·ä¸€ï¼šOHCA (å¿ƒè·³åœæ­¢)",
            flow: ["ç¢ºèªç„¡è„ˆæ", "CPR (30:2)", "AED", "é€²éšå‘¼å¸é“", "çµ¦è—¥"],
            key: ["<strong>é«˜å“è³ª CPRï¼š</strong>æŒ‰å£“ 100-120/åˆ†ï¼Œæ·±åº¦ 5-6cmã€‚ä¸­æ–· < 10ç§’ã€‚", "<strong>å­•å©¦ OHCAï¼š</strong>æ¨å­å®®å‘å·¦ (LUD) æ¸›å°‘ä¸‹è…”éœè„ˆå£“è¿«ã€‚"],
            tp: { action: "é€²éšè—¥ç‰©", drugs: [{ name: "Epinephrine", dose: "1mg IV/IO (æ¯4åˆ†)", ind: "OHCA", warn: "ç„¡æœ€å¤§åŠ‘é‡ã€‚" }, { name: "Amiodarone", dose: "300mg / 150mg", ind: "VF/ç„¡è„ˆVT", warn: "èˆ‡ Epi é–“éš” 1 åˆ†é˜ã€‚" }] }
        },
        {
            id: "Med-2", cat: "medical", title: "éå‰µå‚·äºŒï¼šå‘¼å¸å›°é›£",
            flow: ["çµ¦æ°§", "è½è¨º", "å”åŠ© MDI", "TP æ°£éœ§æ²»ç™‚"],
            key: ["<strong>é‘‘åˆ¥ï¼š</strong>å“®é³´éŸ³ -> æ°£å–˜/COPDï¼›æ¿•å›‰éŸ³ -> å¿ƒè¡°ç«­/è‚ºç‚ã€‚", "<strong>æ°§æ°£ï¼š</strong>COPD ç—…æ‚£å°å¿ƒäºŒæ°§åŒ–ç¢³ç•™æ»¯ (ç›®æ¨™ 88-92%)ã€‚"],
            tp: { action: "æ°£éœ§æ²»ç™‚ (Combivent)", desc: "é©æ‡‰ç—‡ï¼š1æ­²ä»¥ä¸Šï¼Œç„¡å¿ƒè‚Œæ¢—å¡ç—…å²ï¼Œæ°£å–˜/COPD ç™¼ä½œã€‚", drugs: [] }
        },
        {
            id: "Med-6", cat: "medical", title: "éå‰µå‚·å…­ï¼šç–‘ä¼¼è…¦ä¸­é¢¨",
            flow: ["CPSS (è¾›è¾›é‚£æ)", "G-FAST (å¤§è¡€ç®¡)", "æ¸¬è¡€ç³–", "é€šå ±"],
            key: ["<strong>G-FASTï¼š</strong>è‹¥ Gaze (å‡è¦–) ç•°å¸¸ï¼Œé«˜åº¦æ‡·ç–‘å¤§è¡€ç®¡é˜»å¡ (LVO)ï¼Œéœ€é€å¯åŸ·è¡Œå–æ “è¡“ (EVT) é†«é™¢ã€‚", "<strong>ç¦å¿Œï¼š</strong>å‹¿çµ¦è‘¡è„ç³– (é™¤éä½è¡€ç³–)ã€å‹¿é™è¡€å£“ (é™¤é >220/120)ã€‚"],
            tp: null
        },
        {
            id: "Med-7", cat: "medical", title: "éå‰µå‚·ä¸ƒï¼šç¼ºè¡€æ€§èƒ¸ç—›",
            flow: ["12-lead ECG", "æ’é™¤ç¦å¿Œ", "çµ¦è—¥ (NTG/Aspirin)"],
            key: ["<strong>ECGï¼š</strong>ç›®æ¨™ 10 åˆ†é˜å…§å®Œæˆã€‚STEMI é€šå ±å°ç®¡å®¤ã€‚", "<strong>NTG ç¦å¿Œï¼š</strong>SBP < 90ã€HR < 50 æˆ– > 100ã€24-48h å…§æœå£¯é™½è—¥ã€å³å¿ƒå®¤æ¢—å¡ã€‚"],
            tp: { action: "MONA", drugs: [{ name: "Aspirin", dose: "300mg å£æœ", ind: "ç–‘ä¼¼ AMI", warn: "æ’é™¤éæ•/å‡ºè¡€ã€‚" }, { name: "NTG", dose: "0.6mg èˆŒä¸‹", ind: "å¿ƒçµç—›", warn: "åš´å®ˆç¦å¿Œç—‡ã€‚" }] }
        },
        {
            id: "Sp-15", cat: "special", title: "ç‰¹æ®Šåäº”ï¼šé‡å¤–/é•·é€”æ•‘è­· (å¾©èˆˆå€å°ˆå±¬)",
            content: `
                <div class="sec-header">ğŸŒ² å¾©èˆˆå€é‡å¤–/é•·é€”æ•‘è­·å°ˆç«  (114å¹´2æœˆ)</div>
                <p>å®šç¾©ï¼šé€é”é†«é™¢æ™‚é–“ > 1 å°æ™‚ä¹‹åœ°é»ã€‚é‡é»åœ¨æ–¼é•·æ™‚é–“ç…§è­·èˆ‡é€²éšè™•ç½®ã€‚</p>

                <details class="sp-detail" onclick="event.stopPropagation()">
                    <summary><span class="tag-block tag-red">è¨»3</span> å¤–éƒ¨å¤§å‡ºè¡€æ­¢è¡€</summary>
                    <div class="sp-content">
                        <strong>é‡é»ï¼š</strong>ç²¾æº–åŠ å£“ç„¡æ•ˆ -> å‚·å£å¡«å¡ -> æ­¢è¡€å¸¶ã€‚<br>
                        <ul>
                            <li><strong>æ­¢è¡€å¸¶ï¼š</strong>è‹¥é‹é€ > 2å°æ™‚ï¼Œå„ªå…ˆç¶åœ¨å‚·å£è¿‘å¿ƒç«¯ 5-8cmã€‚è‹¥ < 2å°æ™‚å¯è€ƒæ…®å¯¬é¬†è½‰æ›ã€‚</li>
                            <li><strong>å¡«å¡ï¼š</strong>äº¤ç•Œè™•å‡ºè¡€ä½¿ç”¨ã€‚ç¦æ­¢å¡«å¡è»€å¹¹/è…¹è…”ã€‚</li>
                        </ul>
                    </div>
                </details>

                <details class="sp-detail" onclick="event.stopPropagation()">
                    <summary><span class="tag-block tag-blue">è¨»6</span> TBI & IICP é‡å¤–åˆ¤æ–·</summary>
                    <div class="sp-content">
                        <strong>é«˜é¢¨éšªé‹é€æŒ‡æ¨™ï¼š</strong><br>
                        1. åš´é‡é ­ç—›/æŒçºŒå˜”å (IICP æ—©æœŸ)ã€‚<br>
                        2. æ„è­˜æ¸…é†’ä½†ç²¾ç¥ç‹€æ…‹æ”¹è®Šã€‚<br>
                        3. é¡±éª¨éª¨æŠ˜å¾µè±¡ (ç†Šè²“çœ¼/è€³å¾Œç˜€é’)ã€‚<br>
                        <strong>è™•ç½®ï¼š</strong>é é˜²å˜”å (å´è‡¥)ï¼Œç¶­æŒ SBP > 110mmHgã€‚
                    </div>
                </details>

                <details class="sp-detail" onclick="event.stopPropagation()">
                    <summary><span class="tag-block tag-green">è¨»8</span> é ¸è„Šæ¤å‚·å®³ (C-Spine)</summary>
                    <div class="sp-content">
                        <strong>é‡å¤–è„Šæ¤æª¢æ¸¬ (NEXUS æ’é™¤æ³•)ï¼š</strong><br>
                        è‹¥æ‚£è€…æ¸…é†’ã€ç„¡é…’è—¥å½±éŸ¿ã€ç„¡é ¸èƒŒç—›ã€ç„¡ç¥ç¶“å­¸ç•°å¸¸ã€ç„¡è½‰ç§»æ€§åŠ‡ç—› -> <strong>å¯æ’é™¤è„Šæ¤å‚·å®³ï¼Œä¸éœ€å›ºå®š</strong>ã€‚<br>
                        è‹¥éœ€å›ºå®šï¼Œé•·é€”é‹é€å»ºè­°ä½¿ç”¨çœŸç©ºæ°£å¢ŠåºŠå–ä»£é•·èƒŒæ¿ (é¿å…å£“ç˜¡)ã€‚
                    </div>
                </details>
            `,
            tp: null
        },
        { id: "TUT-1", cat: "tutorial", title: "å®‰è£æ•™å­¸", content: "è«‹ä½¿ç”¨ç€è¦½å™¨é¸å–®ä¸­çš„ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚", tp: null }
    ];

    let pMode = false;
    const contentArea = document.getElementById('contentArea');
    const searchInput = document.getElementById('searchInput');
    const fabBtn = document.getElementById('fabBtn');

    function renderCards(filter = 'all', search = '') {
        if (filter === 'ai') { renderChatUI(); return; }
        contentArea.innerHTML = '';
        const filtered = protocols.filter(item => {
            const matchesCat = filter === 'all' ? true : item.cat === filter;
            const matchesSearch = item.title.toLowerCase().includes(search.toLowerCase()) || (item.key && item.key.some(k => k.toLowerCase().includes(search.toLowerCase())));
            const matchesP = pMode ? (item.tp !== null) : true;
            return matchesCat && matchesSearch && matchesP;
        });

        // TP Mode Sorting
        if (pMode) {
            const priorityIds = ["Med-1", "Med-7", "Med-8", "Med-2"]; 
            filtered.sort((a, b) => {
                const idxA = priorityIds.indexOf(a.id);
                const idxB = priorityIds.indexOf(b.id);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return 0;
            });
        }

        if (filtered.length === 0) {
            contentArea.innerHTML = `<div style="text-align:center;color:#666;margin-top:60px;">ç„¡ç›¸é—œæµç¨‹</div>`;
            return;
        }

        let html = '';
        filtered.forEach(item => {
            const isPHighlight = item.tp ? 'p-highlight' : '';
            const isTutHighlight = item.cat === 'tutorial' ? 'tut-highlight' : '';
            
            let flowHtml = '';
            if (item.flow && !pMode) { 
                flowHtml = '<div class="flow-container">';
                item.flow.forEach((step) => { flowHtml += `<div class="flow-step">${step}</div>`; });
                flowHtml += '</div>';
            }

            let bodyHtml = '';
            if (item.content) { 
                bodyHtml = item.content; 
            } else if (!pMode && item.key) {
                bodyHtml += '<div class="sec-header">âš¡ é—œéµè©•ä¼°èˆ‡è™•ç½®</div><ul>';
                item.key.forEach(k => { bodyHtml += `<li><span class="long-text">${k}</span></li>`; });
                bodyHtml += '</ul>';
            }

            let tpHtml = '';
            if (item.tp) {
                tpHtml += `<div class="drug-box"><div class="drug-title"><span class="tp-badge">TP</span> ${item.tp.action || "é«˜ç´šæ•‘è­·è™•ç½®"}</div>${item.tp.desc ? `<p>${item.tp.desc}</p>` : ''}`;
                if (item.tp.drugs) {
                    item.tp.drugs.forEach(d => {
                        tpHtml += `<div class="drug-card"><div style="font-weight:bold;color:#fff;margin-bottom:8px;font-size:1rem;">ğŸ’Š ${d.name}</div><div class="info-row"><div class="info-label">åŠ‘é‡</div><div class="info-val">${d.dose}</div></div><div class="info-row"><div class="info-label">é©æ‡‰ç—‡</div><div class="info-val success">${d.ind}</div></div><div class="info-row"><div class="info-label">è­¦ç¤º</div><div class="info-val danger">${d.warn}</div></div></div>`;
                    });
                }
                tpHtml += `</div>`;
            }

            const expandedClass = pMode ? 'expanded' : '';
            html += `<div class="card ${isPHighlight} ${isTutHighlight} ${expandedClass}" onclick="toggleCard(this)"><div class="card-header"><div>${item.id ? `<span class="card-id">${item.id}</span>` : ''}<span class="card-title">${item.title}</span></div><div class="expand-icon">â–¼</div></div><div class="card-body">${!pMode && item.cat !== 'tutorial' && !item.content ? '<div class="sec-header">ğŸ“‹ æ¨™æº–æµç¨‹</div>' : ''}${flowHtml}${bodyHtml}${tpHtml}</div></div>`;
        });
        contentArea.innerHTML = html;
    }

    function renderChatUI() {
        const kbStatusClass = custom_kb.length > 200 ? 'loaded' : '';
        const kbStatusText = custom_kb.length > 200 ? 'âœ… KB: å·²è¼‰å…¥ (å¯æŸ¥é–±è©³ç´°æ‰‹å†Š)' : 'âš ï¸ KB: æœªè¼‰å…¥ (è«‹ç¢ºèª manual.txt)';
        
        contentArea.innerHTML = `
            <div class="chat-wrapper">
                <div class="api-config-btn" onclick="configureAPI()">âš™ï¸ è¨­å®š</div>
                <div class="chat-messages" id="chatBox">
                    <div class="message msg-ai">
                        ğŸ‘‹ å—¨ï¼æˆ‘æ˜¯æ‚¨çš„ EMT æ™ºèƒ½åŠ©æ‰‹ã€‚<br>
                        è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨ï¼Ÿ<br>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="chat-mic-btn" onclick="startVoiceInput()" id="micBtn">ğŸ¤</button>
                    <button class="chat-send-btn" onclick="sendMessage()">â¤</button>
                </div>
                <div class="kb-status ${kbStatusClass}">${kbStatusText}</div>
            </div>
        `;
    }

    function configureAPI() {
        const key = prompt("è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key:\n(å…è²»ç”³è«‹ï¼šaistudio.google.com)", userApiKey);
        if (key !== null) {
            userApiKey = key;
            localStorage.setItem('gemini_api_key', key);
            alert("API Key å·²å„²å­˜ï¼");
        }
    }

    // Voice Input Function
    function startVoiceInput() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ (å»ºè­°ä½¿ç”¨ Chrome)");
            return;
        }
        const micBtn = document.getElementById('micBtn');
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onstart = function() { micBtn.classList.add('listening'); document.getElementById('chatInput').placeholder = "è«‹èªªè©±..."; };
        recognition.onend = function() { micBtn.classList.remove('listening'); document.getElementById('chatInput').placeholder = "è¼¸å…¥å•é¡Œ..."; };
        recognition.onresult = function(event) { document.getElementById('chatInput').value = event.results[0][0].transcript; };
        recognition.start();
    }

    async function sendMessage(overrideText = null) {
        if (!navigator.onLine) { alert("âŒ ç„¡ç¶²è·¯é€£ç·šï¼Œç„¡æ³•ä½¿ç”¨ AI åŠŸèƒ½ã€‚"); return; }
        if (!userApiKey) { alert("âš ï¸ è«‹å…ˆè¨­å®š API Key"); configureAPI(); return; }

        const inputEl = document.getElementById('chatInput');
        const text = overrideText || inputEl.value.trim();
        if (!text) return;

        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="message msg-user">${text}</div>`;
        if (!overrideText) inputEl.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        const loadingId = 'loading-' + Date.now();
        chatBox.innerHTML += `<div class="message msg-ai" id="${loadingId}"><span class="typing-indicator"></span></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        // Use custom_kb if loaded, otherwise fallback to basic protocols
        const contextData = custom_kb.length > 200 ? custom_kb : JSON.stringify(protocols);
        const sourceNote = custom_kb.length > 200 ? "(æ ¹æ“šå®Œæ•´æ‰‹å†Šè³‡æ–™åº«)" : "(æ ¹æ“šç°¡æ˜“æµç¨‹è³‡æ–™)";

        const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ EMT æ•‘è­·åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™å›ç­”å•é¡Œã€‚
        ã€è³‡æ–™ä¾†æºã€‘ï¼š${sourceNote}
        ã€è³‡æ–™å…§å®¹ã€‘ï¼š${contextData.substring(0, 30000)} (è‹¥éé•·å·²æˆªæ–·)
        
        å›ç­”åŸå‰‡ï¼š
        1. ç°¡æ½”ã€æ¢åˆ—å¼ã€‚
        2. è«‹åœ¨å›ç­”çµå°¾è¨»æ˜ï¼šã€è³‡æ–™ä¾†æºï¼šæ¡ƒåœ’å¸‚æ”¿åºœç·Šæ€¥å‚·ç—…æ‚£æ•‘è­·ä½œæ¥­ç¨‹åºæ‰‹å†Š (114å¹´2æœˆ)ã€ã€‚
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: systemPrompt + "\n\nä½¿ç”¨è€…å•é¡Œï¼š" + text }] }] })
            });

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            document.getElementById(loadingId).innerHTML = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
            document.getElementById(loadingId).innerHTML = "âš ï¸ é€£ç·šéŒ¯èª¤æˆ– API Key ç„¡æ•ˆã€‚";
        }
    }

    // Trigger DB Query (Keep for compatibility)
    window.triggerDatabaseQuery = function(text) { sendMessage(text); };

    function toggleCard(el) { el.classList.toggle('expanded'); }
    function filterCat(cat) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        const targetBtn = document.querySelector(`.tab-btn[onclick="filterCat('${cat}')"]`);
        if(targetBtn) targetBtn.classList.add('active');
        if (pMode) document.querySelector('.tab-btn.p-mode').classList.add('active');
        renderCards(cat, searchInput.value);
    }
    function togglePMode() {
        pMode = !pMode;
        const btn = document.querySelector('.tab-btn.p-mode');
        if (pMode) {
            btn.classList.add('active');
            fabBtn.style.border = "4px solid #fff"; fabBtn.style.boxShadow = "0 0 20px var(--accent-p)"; fabBtn.innerHTML = "é€€å‡º"; fabBtn.style.background = "#b45309"; fabBtn.style.color = "white";
        } else {
            btn.classList.remove('active');
            fabBtn.style.border = "4px solid rgba(255,255,255,0.15)"; fabBtn.style.boxShadow = "0 4px 20px rgba(0,0,0,0.5)"; fabBtn.innerHTML = "TP<span>æ¨¡å¼</span>"; fabBtn.style.background = "var(--accent-p)"; fabBtn.style.color = "black";
        }
        const activeCatBtn = document.querySelector('.tab-btn.active:not(.p-mode)');
        const cat = activeCatBtn ? activeCatBtn.getAttribute('onclick').match(/'(.*)'/)[1] : 'all';
        renderCards(cat, searchInput.value);
    }
    searchInput.addEventListener('input', (e) => {
        const activeCatBtn = document.querySelector('.tab-btn.active:not(.p-mode)');
        const cat = activeCatBtn ? activeCatBtn.getAttribute('onclick').match(/'(.*)'/)[1] : 'all';
        renderCards(cat, e.target.value);
    });

    renderCards();
</script>
</body>
</html>
