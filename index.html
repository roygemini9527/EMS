<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¡ƒåœ’119å¤§è»ŠéšŠå¤–é€ç¾å ´æ”»ç•¥ v8.3 (114å¹´æ‰‹å†Šç‰ˆ)</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="119æ”»ç•¥">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">

    <!-- App Icon -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/roygemini9527/EMS/ee1e9df4074200e2c03b07974d87d74a9af0926c/LOGO.png">
    <link rel="icon" type="image/png" sizes="any" href="https://raw.githubusercontent.com/roygemini9527/EMS/ee1e9df4074200e2c03b07974d87d74a9af0926c/LOGO.png">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/roygemini9527/EMS/ee1e9df4074200e2c03b07974d87d74a9af0926c/LOGO.png">
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E6%A1%83%E5%9C%92119%E6%94%BB%E7%95%A5%22%2C%22short_name%22%3A%22119%E6%94%BB%E7%95%A5%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23111827%22%2C%22theme_color%22%3A%22%231f2937%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fraw.githubusercontent.com%2Froygemini9527%2FEMS%2Fee1e9df4074200e2c03b07974d87d74a9af0926c%2FLOGO.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

    <style>
        /* Base Styles */
        :root { --primary: #dc2626; --primary-dark: #991b1b; --bg-dark: #111827; --bg-card: #1f2937; --text-main: #f3f4f6; --text-sub: #9ca3af; --accent-p: #f59e0b; --success: #10b981; --info: #3b82f6; --ai-color: #8b5cf6; --border: #374151; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 100px; line-height: 1.6; -webkit-user-select: none; user-select: none; }
        
        /* Header */
        header { background-color: rgba(31, 41, 55, 0.98); padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); transition: top 0.3s ease-in-out; }
        header.nav-up { top: -150px; }
        h1 { font-size: 1.25rem; margin: 0 0 10px 0; color: #fca5a5; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px; text-align: center; }
        .version-tag { font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 12px; color: var(--text-sub); }
        .controls-row { display: flex; gap: 8px; position: relative; }
        .guide-btn { flex: 0 0 20%; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); color: var(--info); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        .search-input { flex: 1; background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 10px; font-size: 16px; transition: all 0.2s; }
        .search-input:focus { border-color: var(--accent-p); outline: none; background: #1a1a1a; }

        /* Guide Panel */
        .guide-panel { position: absolute; top: 110%; left: 0; width: 100%; background: var(--bg-card); border: 1px solid var(--info); border-radius: 10px; padding: 16px; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.9); display: none; max-height: 80vh; overflow-y: auto; }
        .guide-panel.open { display: block; }
        .guide-panel h3 { color: var(--info); margin-top: 0; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 8px; }
        .guide-panel p { font-size: 0.95rem; color: #d1d5db; margin-bottom: 12px; }
        
        /* Tabs */
        .nav-tabs { display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px; background: var(--bg-dark); border-bottom: 1px solid var(--border); position: sticky; top: 115px; z-index: 40; transition: top 0.3s ease-in-out; }
        header.nav-up + .nav-tabs { top: 0; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-sub); padding: 8px 16px; border-radius: 20px; font-size: 0.95rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 0 10px rgba(220, 38, 38, 0.4); }
        .tab-btn.ai-tab { border-color: var(--ai-color); color: var(--ai-color); }
        .tab-btn.ai-tab.active { background: var(--ai-color); color: white; box-shadow: 0 0 10px rgba(139, 92, 246, 0.4); }
        .tab-btn.p-mode.active { background: var(--accent-p); color: black; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }

        /* Cards */
        .container { padding: 16px; max-width: 800px; margin: 0 auto; }
        .card { background: var(--bg-card); border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border); overflow: hidden; transition: transform 0.1s; }
        .card.p-highlight { border-left: 4px solid var(--accent-p); }
        .card.tut-highlight { border-left: 4px solid var(--info); }
        .card-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; min-height: 50px; background: linear-gradient(to right, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); }
        .card-title { font-weight: 700; font-size: 1.1rem; color: #fff; }
        .card-id { font-size: 0.75rem; color: var(--text-sub); background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 6px; margin-right: 10px; font-family: monospace; }
        .card-body { display: none; padding: 16px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.1); }
        .card.expanded .card-body { display: block; }
        .expand-icon { transition: transform 0.3s; color: var(--text-sub); }
        .card.expanded .expand-icon { transform: rotate(180deg); color: white; }

        /* Content Styling */
        p, li { color: #d1d5db; font-size: 0.95rem; line-height: 1.7; }
        strong { color: white; }
        .sec-header { display: flex; align-items: center; gap: 8px; margin: 20px 0 10px 0; color: var(--primary-light); font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        
        /* Flowchart & Tags */
        .flow-container { display: flex; flex-direction: column; gap: 12px; margin: 16px 0; padding-left: 10px; border-left: 2px solid var(--border); }
        .flow-step { background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 12px; border-radius: 0 8px 8px 0; position: relative; font-size: 0.95rem; }
        .flow-step::before { content: ""; position: absolute; left: -12px; top: 50%; width: 10px; height: 2px; background: var(--border); }
        .tag-block { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 6px; font-weight: bold; }
        .tag-red { background: rgba(220, 38, 38, 0.2); color: #fca5a5; border: 1px solid #dc2626; }
        .tag-blue { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid #3b82f6; }
        .tag-green { background: rgba(16, 185, 129, 0.2); color: #86efac; border: 1px solid #10b981; }
        .tag-orange { background: rgba(249, 115, 22, 0.2); color: #fdba74; border: 1px solid #f97316; }

        /* TP & Drug Cards */
        .drug-box { background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 8px; padding: 14px; margin-top: 16px; }
        .drug-title { color: var(--accent-p); font-weight: 800; font-size: 1.1rem; border-bottom: 1px solid rgba(245, 158, 11, 0.2); padding-bottom: 8px; margin-bottom: 12px; }
        .tp-badge { background: var(--accent-p); color: black; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 8px; }
        .drug-card { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--accent-p); }
        .info-row { display: flex; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
        .info-row:last-child { border-bottom: none; }
        .info-label { width: 70px; color: var(--text-sub); font-size: 0.85rem; flex-shrink: 0; }
        .info-val { color: #f3f4f6; font-size: 0.95rem; font-weight: 500; }
        .info-val.danger { color: #fca5a5; } .info-val.success { color: #86efac; }

        /* AI Chat */
        .chat-wrapper { display: flex; flex-direction: column; height: calc(100vh - 180px); background: #1f2937; border-radius: 12px; border: 1px solid #374151; position: relative; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .message { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; user-select: text; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-ai { align-self: flex-start; background: #374151; color: #e5e7eb; border-bottom-left-radius: 4px; border-left: 3px solid var(--ai-color); }
        .chat-input-area { padding: 12px; background: rgba(0,0,0,0.3); border-top: 1px solid #374151; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px 16px; border-radius: 24px; border: 1px solid #4b5563; background: #111827; color: white; font-size: 16px; }
        .chat-send-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--ai-color); border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .chat-mic-btn { width: 44px; height: 44px; border-radius: 50%; background: #4b5563; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .chat-mic-btn.listening { background: #ef4444; animation: pulse 1.5s infinite; }
        
        .db-btn { display: inline-flex; align-items: center; margin-top: 10px; padding: 6px 12px; background: rgba(139, 92, 246, 0.15); border: 1px solid var(--ai-color); color: #c4b5fd; border-radius: 8px; font-size: 0.85rem; cursor: pointer; }
        .api-config-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.4); color: #9ca3af; border: 1px solid #4b5563; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; z-index: 10; }
        
        .fab { position: fixed; bottom: 30px; right: 24px; background-color: var(--accent-p); color: #000; width: 68px; height: 68px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 4px 20px rgba(0,0,0,0.5); cursor: pointer; z-index: 100; font-size: 1.4rem; border: 4px solid rgba(255,255,255,0.15); margin-bottom: env(safe-area-inset-bottom); }
        .fab span { font-size: 0.75rem; font-weight: normal; margin-top: -4px;}
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* KB Status Indicator */
        .kb-status { font-size: 0.7rem; color: #6b7280; text-align: center; margin-top: 4px; }
        .kb-status.loaded { color: var(--success); }
    </style>
</head>
<body>

<header>
    <h1>æ¡ƒåœ’119å¤§è»ŠéšŠå¤–é€ç¾å ´æ”»ç•¥ <span class="version-tag">v8.3 (114å¹´ç‰ˆ)</span></h1>
    <div class="controls-row">
        <div class="guide-btn" onclick="toggleGuide()">ğŸ“– èªªæ˜</div>
        <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœå°‹ï¼šOHCAã€ä¸­é¢¨ã€é‡å¤–...">
        <div class="guide-panel" id="guidePanel">
            <h3>ğŸ“– ä½¿ç”¨èªªæ˜ & AI æ•™å­¸</h3>
            <p><strong>âœ¨ AI åŠ©æ‰‹æ“ä½œ (é‡é»)ï¼š</strong></p>
            <ul>
                <li><strong>1. æ¨™æº–å›ç­”ï¼š</strong> AI æœƒå„ªå…ˆæ ¹æ“šæœ¬æ”»ç•¥çš„ã€Œæ¨™æº–æµç¨‹ã€å›ç­”ã€‚</li>
                <li><strong>2. ğŸ“š èª¿é–±è³‡æ–™åº« (è‡ªè¨‚çŸ¥è­˜åº«)ï¼š</strong> 
                    <br>ç‚ºäº†åŠ å¿«ç¨‹å¼é‹ä½œï¼Œè«‹å°‡æ‰‹å†Šå…§å®¹å­˜ç‚º <strong>manual.txt</strong> ä¸¦æ”¾åœ¨ç›¸åŒç›®éŒ„ä¸‹ã€‚
                    <br>ç•¶çœ‹åˆ°ã€Œâœ… KB: å·²è¼‰å…¥ã€æ™‚ï¼ŒAI æ‰èƒ½ç²¾ç¢ºå¼•ç”¨æ‰‹å†Šé æ•¸èˆ‡å…§å®¹ã€‚
                </li>
            </ul>
            <p><strong>å…¶ä»–åŠŸèƒ½ï¼š</strong></p>
            <ul>
                <li><strong>TP æ¨¡å¼ï¼š</strong>é»æ“Šå³ä¸‹è§’é»ƒè‰²æŒ‰éˆ•ï¼Œåˆ‡æ›é«˜ç´šæ•‘è­·å“¡æ¨¡å¼ã€‚ç³»çµ±æœƒè‡ªå‹•å°‡<strong>ã€ŒOHCAã€èƒ¸ç—›ã€è‚ºæ°´è…«ã€æ°£å–˜ã€</strong>ç½®é ‚ã€‚</li>
            </ul>
            <div style="text-align:right; margin-top:20px; color:var(--info); cursor:pointer; font-weight:bold;" onclick="toggleGuide()">[é—œé–‰èªªæ˜]</div>
        </div>
    </div>
</header>

<div class="nav-tabs">
    <div class="tab-btn active" onclick="filterCat('all')">å…¨è¦½</div>
    <div class="tab-btn ai-tab" onclick="filterCat('ai')">âœ¨ AI åŠ©æ‰‹</div>
    <div class="tab-btn p-mode" onclick="togglePMode()">TP å°ˆå€</div>
    <div class="tab-btn" onclick="filterCat('general')">é€šç”¨</div>
    <div class="tab-btn" onclick="filterCat('airway')">å‘¼å¸é“</div>
    <div class="tab-btn" onclick="filterCat('medical')">å…§ç§‘</div>
    <div class="tab-btn" onclick="filterCat('trauma')">å‰µå‚·</div>
    <div class="tab-btn" onclick="filterCat('special')">ç‰¹æ®Š</div>
    <div class="tab-btn tutorial" onclick="filterCat('tutorial')">ğŸ“± æ‰‹æ©Ÿå®‰è£æ•™å­¸</div>
</div>

<div class="container" id="contentArea"></div>
<div class="fab" onclick="togglePMode()" id="fabBtn">TP<span>æ¨¡å¼</span></div>

<script>
    // ==========================================
    // ğŸš€ è³‡æ–™åº«å„ªåŒ–å€ (Knowledge Base Optimization)
    // è¦å‰‡ï¼šå„ªå…ˆå¾å¤–éƒ¨ manual.txt è®€å–ã€‚
    // ==========================================
    let custom_kb = ""; 
    const KB_FILE_URL = "./manual.txt"; // è«‹ç¢ºä¿æ­¤æª”æ¡ˆå­˜åœ¨æ–¼ç›¸åŒç›®éŒ„

    async function loadKnowledgeBase() {
        try {
            const response = await fetch(KB_FILE_URL);
            if (!response.ok) throw new Error("File not found");
            custom_kb = await response.text();
            console.log("âœ… æˆåŠŸè¼‰å…¥å¤–éƒ¨æ‰‹å†Šè³‡æ–™åº«");
            const statusEl = document.querySelector('.kb-status');
            if(statusEl) {
                statusEl.textContent = "âœ… KB: å·²è¼‰å…¥ (å¯æŸ¥é–±è©³ç´°æ‰‹å†Š)";
                statusEl.classList.add('loaded');
            }
        } catch (error) {
            console.warn("âš ï¸ ç„¡æ³•è¼‰å…¥ manual.txtã€‚");
            const statusEl = document.querySelector('.kb-status');
            if(statusEl) {
                statusEl.textContent = "âš ï¸ KB: æœªè¼‰å…¥ (è«‹ç¢ºèª manual.txt å­˜åœ¨)";
            }
        }
    }
    
    // åˆå§‹åŒ–è¼‰å…¥
    loadKnowledgeBase();
    // ==========================================

    function toggleGuide() {
        const panel = document.getElementById('guidePanel');
        panel.classList.toggle('open');
    }

    let lastScrollTop = 0;
    const header = document.querySelector('header');
    window.addEventListener('scroll', function() {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop > lastScrollTop && scrollTop > 100) header.classList.add('nav-up');
        else header.classList.remove('nav-up');
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }, false);

    // HTML Template for Epinephrine Text
    const epiNebulizerHtml = `
        <div style="margin-top:8px; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.2);">
            <strong>ğŸ”¥ è…ä¸Šè…ºç´ æ°£éœ§æ²»ç™‚ (Epinephrine Nebulization)</strong>
            <ul>
                <li><strong>é©æ‡‰ç—‡ï¼š</strong>ç«å ´æ•‘å‡ºæˆ–ç¼ç‡™å‚·ï¼Œä¼´éš¨ä¸Šå‘¼å¸é“é˜»å¡å¾µè±¡ï¼ˆå–‰åš¨ç—›ã€ååš¥å›°é›£ã€å–˜é³´éŸ³ Stridorï¼‰ã€‚</li>
                <li><strong>é…æ–¹ï¼š</strong>1mg (1 amp) Epinephrine + 3ml N/S ç½®å…¥éœ§åŒ–æ¯ã€‚</li>
                <li><strong>è¨­å®šï¼š</strong>æ¥æ°§æ°£é¢ç½©ï¼Œæ°§æ°£æµé€Ÿ <strong>6 L/min</strong> (æµé€Ÿéå¿«æœƒé™ä½éœ§åŒ–æ•ˆæœ)ã€‚</li>
                <li><strong>åŠ‘é‡èª¿æ•´ï¼š</strong><br> - > 1 æ­²ï¼š1 amp<br> - 3å€‹æœˆ~1æ­²ï¼š0.5 amp<br> - < 3å€‹æœˆï¼š0.25 amp</li>
            </ul>
        </div>
    `;

    const protocols = [
        {
            id: "G-1", cat: "general", title: "é€šç”¨ä¸€ï¼šç·Šæ€¥æ•‘è­·ç¾å ´é€šç”¨æµç¨‹",
            flow: ["åˆ°é”ç¾å ´ -> åœè»Šæ–¼å®‰å…¨ä½ç½®", "å®‰å…¨è©•ä¼° (3S: Scene, Safety, Situation)", "è‡ªæˆ‘ä¿è­· (BSI: æˆ´æ‰‹å¥—ã€å£ç½©ã€è­·ç›®é¡)", "åˆ¤æ–·æ˜¯å¦éœ€æ”¯æ´ / å•Ÿå‹•å¤§é‡å‚·ç—…æ‚£æ©Ÿåˆ¶", "åˆ¤æ–·æ¡ˆä»¶å±¬æ€§ (å‰µå‚·/éå‰µå‚·)"],
            key: [
                "<strong>ç¾å ´å®‰å…¨ (Scene Safety)</strong> æ˜¯æ‰€æœ‰æ•‘è­·çš„åŸºç¤ã€‚è‹¥ç¾å ´æœ‰æš´åŠ›å¨è„…ã€åŒ–å­¸ç‰©è³ªæ´©æ¼ã€ç«ç½æˆ–å€’å¡Œé¢¨éšªï¼Œæ•‘è­·äººå“¡æ‡‰ç«‹å³æ’¤é€€è‡³å®‰å…¨å€åŸŸï¼Œä¸¦è«‹æ±‚è­¦æ¶ˆæˆ–ç‰¹ç¨®å–®ä½æ”¯æ´ï¼Œåˆ‡å‹¿è²¿ç„¶é€²å…¥å±éšªå€åŸŸã€‚",
                "<strong>è³‡æºè©•ä¼°ï¼š</strong>è‹¥å‚·ç—…æ‚£äººæ•¸è¶…é 15 äººï¼Œæˆ–å±æ€¥å€‹æ¡ˆè¶…é 5 äººï¼Œæ‡‰ç«‹å³å›å ±æŒ‡æ®ä¸­å¿ƒå•Ÿå‹•ã€Œå¤§é‡å‚·ç—…æ‚£ (MCI)ã€æ©Ÿåˆ¶ï¼Œä¸¦å»ºç«‹æŒ‡æ®ç«™é€²è¡Œæª¢å‚·åˆ†é¡ã€‚",
                "<strong>æ„ŸæŸ“æ§åˆ¶ï¼š</strong>æ¥è§¸ä»»ä½•æ‚£è€…å‰å‹™å¿…ç©¿æˆ´å®Œæ•´é˜²è­·è£å‚™ã€‚è‹¥æ‡·ç–‘å‘¼å¸é“å‚³æŸ“ç—…ï¼ˆå¦‚è‚ºçµæ ¸ã€COVID-19ï¼‰ï¼Œæ‡‰å‡ç´šé…æˆ´ N95 å£ç½©ä¸¦å„˜é‡ä¿æŒé€šé¢¨ã€‚"
            ],
            tp: null
        },
        {
            id: "G-2", cat: "general", title: "é€šç”¨äºŒï¼šéå‰µå‚·ç¾å ´æµç¨‹",
            flow: ["æ„è­˜è©•ä¼° (AVPU/GCS)", "ABCDE åˆæ­¥è©•ä¼°", "ç—…å²è©¢å• (SAMPLE, OPQRST)", "ç”Ÿå‘½å¾µè±¡é‡æ¸¬", "å±æ€¥åº¦åˆ¤æ–· & è™•ç½®"],
            key: [
                "<strong>æ„è­˜èˆ‡å‘¼å¸ï¼š</strong>è‹¥æ‚£è€…æ„è­˜ä¸æ¸… (U) ä¸”ç„¡é©ç•¶å‘¼å¸/è„ˆæï¼Œæ‡‰è¦–ç‚º OHCAï¼Œç«‹å³é–‹å§‹ CPRã€‚è‹¥æœ‰å‘¼å¸ä½†æ„è­˜ä¸æ¸…ï¼Œæ‡‰æ³¨æ„å‘¼å¸é“æ˜¯å¦é€šæš¢ï¼ˆé¼¾éŸ³/å›‰éŸ³ï¼‰ã€‚",
                "<strong>å‘¼å¸è©•ä¼° (B)ï¼š</strong>æ­£å¸¸æˆäººå‘¼å¸é€Ÿç‡ 12-20 æ¬¡/åˆ†ã€‚ä¸€èˆ¬æ‚£è€…æ°§æ°£æ²»ç™‚ç›®æ¨™ç‚º SpO2 â‰¥ 94%ï¼›è‹¥æœ‰ COPD ç—…å²ï¼Œç›®æ¨™èª¿æ•´ç‚º 88-92% ä»¥é¿å…äºŒæ°§åŒ–ç¢³æ»¯ç•™ã€‚",
                "<strong>å¾ªç’°è©•ä¼° (C)ï¼š</strong>æª¢æŸ¥æ©ˆå‹•è„ˆï¼ˆè‹¥æ‘¸ä¸åˆ°å‰‡é‡é ¸å‹•è„ˆï¼Œæš—ç¤º SBP < 80 mmHgï¼‰ã€‚è©•ä¼°è†šè‰²ï¼ˆè’¼ç™½/ç™¼ç´º/å¤§ç†çŸ³æ–‘ï¼‰ã€é«”æº«åŠå¾®è¡€ç®¡å……å¡«æ™‚é–“ (CRT > 2ç§’è¡¨çŒæµå·®)ã€‚",
                "<strong>ç—…å²è©¢å•ï¼š</strong>å–„ç”¨ SAMPLE (ç—‡ç‹€ã€éæ•ã€è—¥ç‰©ã€ç—…å²ã€æœ€å¾Œä¸€é¤ã€äº‹ä»¶) èˆ‡ OPQRST (ç™¼ä½œã€èª˜å› ã€æ€§è³ªã€è½‰ç§»ã€åš´é‡åº¦ã€æ™‚é–“) å¿«é€ŸæŒæ¡ç—…æƒ…ã€‚"
            ],
            tp: null
        },
        {
            id: "G-3", cat: "general", title: "é€šç”¨ä¸‰ï¼šå‰µå‚·ç¾å ´æµç¨‹",
            flow: ["åˆ¤æ–·é ¸æ¤é™åˆ¶ (SMR) éœ€æ±‚", "X (å¤§å‡ºè¡€æ­¢è¡€) -> A -> B -> C", "å¿«é€Ÿå‰µå‚·è©•ä¼° (é ­åˆ°è…³)", "è‡´å‘½å‚·è™•ç½® (æ°£èƒ¸/é€£æ·èƒ¸)", "ä¸Šé•·èƒŒæ¿/KED (è¦–éœ€æ±‚)"],
            key: [
                "<strong>é ¸æ¤é™åˆ¶ (SMR)ï¼š</strong>é«˜èƒ½é‡æ©Ÿè½‰ï¼ˆé«˜è™•å¢œè½ > 6mã€è»Šç¦è»Šé«”è®Šå½¢ã€æ˜è¿· GCS<15ã€é ¸èƒŒç—›ã€å››è‚¢éº»æœ¨ï¼‰æ‡‰å‡è¨­é ¸æ¤å—å‚·ï¼Œç«‹å³çµ¦äºˆé ¸åœˆåŠå¾’æ‰‹å›ºå®šï¼Œé¿å…äºŒæ¬¡å‚·å®³ã€‚",
                "<strong>X (Exsanguination)ï¼š</strong>åœ¨ ABC ä¹‹å‰å„ªå…ˆè™•ç†å‹•è„ˆå™´å°„å‡ºè¡€ã€‚ç›´æ¥åŠ å£“ç„¡æ•ˆæ™‚ï¼Œæ‡‰ç«‹å³ä½¿ç”¨æ­¢è¡€å¸¶ (CAT)ï¼Œç¶åœ¨å‚·å£è¿‘å¿ƒç«¯ 5-8 å…¬åˆ†è™•ã€‚",
                "<strong>å¿«é€Ÿå‰µå‚·è©•ä¼°ï¼š</strong>é‡å°é ­ã€é ¸ã€èƒ¸ã€è…¹ã€éª¨ç›†ã€å››è‚¢é€²è¡Œå¿«é€Ÿè§¸è¨ºèˆ‡è¦–è¨ºã€‚æ³¨æ„é ­éƒ¨å¤–å‚·æ˜¯å¦ä¼´éš¨ Cushing Triad (é«˜è¡€å£“ã€ç·©è„ˆã€å‘¼å¸ä¸è¦å‰‡)ã€‚",
                "<strong>Load and Goï¼š</strong>è‹¥ç”Ÿå‘½å¾µè±¡ä¸ç©©å®šï¼Œä¸æ‡‰åœ¨ç¾å ´é€²è¡Œè©³ç´°åŒ…ç´®æˆ–éª¨æŠ˜å›ºå®šï¼Œæ‡‰åœ¨æ•‘è­·è»Šè¡Œé€²é–“å®Œæˆè™•ç½®ï¼Œç¸®çŸ­ç¾å ´åœç•™æ™‚é–“ã€‚"
            ],
            tp: null
        },
        {
            id: "G-4", cat: "general", title: "é€šç”¨å››ï¼šç—…æƒ…å±æ€¥åº¦åˆ¤æ–·",
            flow: ["ç”Ÿå‘½å¾µè±¡æª¢æ ¸", "å‰µå‚·éƒ¨ä½æª¢æ ¸", "å‰µå‚·æ©Ÿè½‰æª¢æ ¸", "ç‰¹æ®Šç‹€æ³æª¢æ ¸"],
            key: [
                "<strong>ç”Ÿå‘½å¾µè±¡å±æ€¥æŒ‡æ¨™ (æˆäºº)ï¼š</strong><br>1. å‘¼å¸ (RR): > 29 æˆ– < 10 æ¬¡/åˆ†<br>2. å¿ƒè·³ (HR): > 150 æˆ– < 50 æ¬¡/åˆ†<br>3. è¡€å£“ (SBP): > 200 æˆ– < 90 mmHg<br>4. è¡€æ°§ (SpO2): < 90%<br>5. æ„è­˜ (GCS): < 14 åˆ†æˆ–æ€¥æ€§æ”¹è®Š<br>6. é«”æº«: > 41â„ƒ æˆ– < 32â„ƒ",
                "<strong>è™•ç½®åŸå‰‡ï¼š</strong>ç¬¦åˆä»»ä¸€é …å³ç‚ºå±æ€¥å€‹æ¡ˆã€‚æ‡‰ç«‹å³çµ¦äºˆé«˜æ¿ƒåº¦æ°§æ°£ã€å»ºç«‹ IV ç®¡è·¯ã€æŒçºŒç›£æ¸¬ç”Ÿå‘½å¾µè±¡ï¼Œä¸¦é å…ˆé€šå ±æ¥æ”¶é†«é™¢æº–å‚™æ€¥æ•‘å®¤ã€‚",
                "<strong>ç‰¹æ®Šç‹€æ³ï¼š</strong>åŒ…å«åš´é‡ç‡’ç‡™å‚· (>25%)ã€å¸å…¥æ€§å—†å‚·ã€æ°£ç®¡æå‚·ã€å…§è‡Ÿå¤–éœ²ã€æ‰‹è…•/è…³è¸ä»¥ä¸Šæˆªè‚¢ã€éª¨ç›†éª¨æŠ˜ã€å…©è™•ä»¥ä¸Šé•·éª¨éª¨æŠ˜ã€å£“ç¢å‚·ç­‰ã€‚"
            ],
            tp: null
        },
        {
            id: "G-5", cat: "general", title: "é€šç”¨äº”ï¼šæ•‘è­·è»Šå…§æ•‘è­·æµç¨‹",
            flow: ["æŒçºŒç›£æ¸¬ç”Ÿå‘½å¾µè±¡", "å†è©•ä¼°è™•ç½®æ•ˆæœ (äºŒåº¦è©•ä¼°)", "ç„¡ç·šé›»å›å ±é†«é™¢ (MIST)", "è©³ç´°èº«é«”æª¢æŸ¥"],
            key: [
                "<strong>ç›£æ¸¬é »ç‡ï¼š</strong>å±æ€¥å€‹æ¡ˆæ‡‰è‡³å°‘æ¯ 5 åˆ†é˜è©•ä¼°ä¸€æ¬¡ç”Ÿå‘½å¾µè±¡ï¼›éå±æ€¥å€‹æ¡ˆè‡³å°‘æ¯ 15 åˆ†é˜ä¸€æ¬¡ã€‚è‹¥ç—…æƒ…æƒ¡åŒ–ï¼ˆå¦‚æ„è­˜è®Šå·®ã€è¡€å£“ä¸‹é™ï¼‰ï¼Œæ‡‰ç«‹å³é‡æ–°åŸ·è¡Œ ABC è©•ä¼°ã€‚",
                "<strong>è™•ç½®èª¿æ•´ï¼š</strong>ä¾æ“š SpO2 èª¿æ•´æ°§æ°£æµé‡ã€‚ä¼‘å…‹æ‚£è€…è‹¥ç„¡è„Šæ¤æå‚·ç–‘æ…®ï¼Œå¯æŠ¬é«˜ä¸‹è‚¢ 20-30 åº¦ã€‚æ³¨æ„ä¿æš–ï¼Œé¿å…ä½é«”æº«æƒ¡åŒ–å‡è¡€åŠŸèƒ½ã€‚",
                "<strong>ç„¡ç·šé›»å›å ± (MIST)ï¼š</strong><br>M: æ©Ÿè½‰ (Mechanism/Medical complaint)<br>I: å‚·å‹¢/ç™¼ç¾ (Injuries/Inspection)<br>S: å¾µè±¡ (Signs: GCS, BP, HR, RR, SpO2)<br>T: è™•ç½® (Treatment given)",
                "<strong>è©³ç´°æª¢æŸ¥ï¼š</strong>åœ¨è»Šä¸Šç’°å¢ƒè¨±å¯ä¸‹ï¼ŒåŸ·è¡Œè©³ç´°çš„é ­åˆ°è…³èº«é«”æª¢æŸ¥ (Secondary Survey)ï¼Œå°‹æ‰¾éºæ¼çš„å‚·å£æˆ–ç—…å¾µã€‚"
            ],
            tp: {
                action: "é€²éšç›£æ¸¬èˆ‡è™•ç½®",
                desc: "TP å¯åœ¨è»Šä¸ŠåŸ·è¡Œé€²éšå¿ƒè‡Ÿç›£æ¸¬ (12-lead ECG)ã€‚è‹¥ AED å»ºè­°é›»æ“Šï¼Œå¯è¦–è·¯æ³åœè»Šæˆ–åœ¨å®‰å…¨ç‹€æ³ä¸‹é›»æ“Šã€‚è‹¥ç‚ºä¸ç©©å®šå¿ƒå¾‹ (é »è„ˆ/ç·©è„ˆ)ï¼Œå¯è€ƒæ…®åŒæ­¥æ•´æµæˆ– TCPã€‚"
            }
        },
        {
            id: "G-6", cat: "general", title: "é€šç”¨å…­ï¼šåˆ°é”é†«é™¢å¾Œæµç¨‹",
            flow: ["è»Šè¼›åœå¦¥", "å”åŠ©ç§»åºŠ", "æª¢å‚·äº¤æ¥ (MIST)", "å¡«å¯«ç´€éŒ„è¡¨", "è»Šå…§æ¶ˆæ¯’/è£œè€—æ"],
            key: [
                "<strong>äº¤æ¥é‡é»ï¼š</strong>å‹™å¿…å°‡æ‚£è€…åˆ°é”é†«é™¢å‰çš„è®ŠåŒ–è¶¨å‹¢å‘ŠçŸ¥æª¢å‚·è­·ç†å¸«ã€‚ä¾‹å¦‚ï¼šã€Œç¾å ´æ„è­˜æ¸…æ¥šï¼Œè»Šä¸Šè½‰ç‚ºå—œç¡ã€ã€ã€Œè¡€å£“ç”± 110 æ‰åˆ° 80ã€ã€‚",
                "<strong>å±æ€¥å€‹æ¡ˆï¼š</strong>ç¢ºèªæª¢å‚·è­·ç†å¸«å·²æ¥æ”¶è¨Šæ¯ï¼Œä¸¦å”åŠ©æ¨å…¥æ€¥æ•‘å®¤ã€‚è‹¥æœ‰æ’ç®¡æˆ–ä½¿ç”¨æ€¥æ•‘è—¥ç‰©ï¼Œéœ€è©³ç´°èªªæ˜çµ¦è—¥æ™‚é–“èˆ‡åŠ‘é‡ã€‚",
                "<strong>æ„ŸæŸ“æ§åˆ¶ï¼š</strong>é›¢é–‹å‰å‹™å¿…å®Œæˆè»Šå…§æ¥è§¸é¢æ¶ˆæ¯’ã€‚è‹¥è¼‰é€å‚³æŸ“ç—…æ‚£ï¼Œéœ€ä¾è¦å®šé€²è¡Œçµ‚æœŸæ¶ˆæ¯’ä¸¦æ›´æ›ç›¸é—œè€—æã€‚",
                "<strong>ç´€éŒ„è¡¨ï¼š</strong>å„˜é€Ÿå®Œæˆé›»å­æ•‘è­·ç´€éŒ„è¡¨å¡«å¯«èˆ‡ä¸Šå‚³ï¼Œç¢ºä¿é†«ç™‚è³‡è¨Šé€£çºŒæ€§ã€‚"
            ],
            tp: null
        },

        // ====== ç·šä¸Š (Online) ======
        {
            id: "On-1", cat: "general", title: "ç·šä¸Šä¸€ï¼šç·šä¸Šé†«ç™‚æŒ‡å°ä½œæ¥­",
            flow: ["åˆ¤æ–·æŒ‡å°éœ€æ±‚", "æ’¥æ‰“æŒ‡å°å°ˆç·š/ç„¡ç·šé›»", "å ±å‘Šç—…æ³èˆ‡éœ€æ±‚", "é†«å¸«è¦†æ ¸", "éŒ„éŸ³å­˜è­‰"],
            key: [
                "<strong>éœ€ç”³è«‹æŒ‡å°é …ç›®ï¼š</strong><br>1. TP ç®¡åˆ¶è—¥ç‰©çµ¦äºˆï¼ˆå¦‚ Morphine, Fentanyl, Midazolam - è¦–å„ç¸£å¸‚é–‹æ”¾ç¨‹åº¦ï¼‰<br>2. åš´é‡å‰µå‚·çµ¦äºˆ TXA (Tranexamic Acid)<br>3. æ‹’çµ•é€é†«æœ‰çˆ­è­°æ™‚ (å¦‚å®¶å±¬è¦æ±‚ä¸é€é†«ä½†æ‚£è€…å±æ€¥)<br>4. DNR æ–‡ä»¶æœ‰ç–‘ç¾©æˆ–ç¾å ´å®¶å±¬æ„è¦‹åˆ†æ­§<br>5. çµ‚æ­¢æ€¥æ•‘ (Pronounce death) ä¹‹åˆ¤å®š",
                "<strong>é€šè©±è¦é ˜ï¼š</strong>æ˜ç¢ºå‘ŠçŸ¥å–®ä½ã€å§“åã€ç´šåˆ¥ã€‚ç°¡å ±æ‚£è€…æ€§åˆ¥ã€å¹´é½¡ã€ä¸»è¨´ã€ç”Ÿå‘½å¾µè±¡ã€å·²åšè™•ç½®åŠã€Œè«‹æ±‚äº‹é …ã€ã€‚é€šè©±éç¨‹éœ€å…¨ç¨‹éŒ„éŸ³ï¼Œä¸¦åœ¨ç´€éŒ„è¡¨ä¸Šè¨»è¨˜æŒ‡å°é†«å¸«å§“åèˆ‡é†«å›‘å…§å®¹ã€‚"
            ],
            tp: null
        },

        // ====== å‘¼å¸é“ (Airway) ======
        {
            id: "Air-3", cat: "airway", title: "å‘¼å¸é“ä¸‰ï¼šå‘¼å¸é“ç•°ç‰©å“½å¡ (FBAO)",
            flow: ["åˆ†è¾¨è¼•åº¦/é‡åº¦é˜»å¡", "æ„è­˜æ˜¯å¦å–ªå¤±", "å“ˆå§†ç«‹å…‹æ³•", "CPR"],
            key: [
                "<strong>æ¸…é†’ (é‡åº¦)ï¼š</strong>å“ˆå§†ç«‹å…‹æ³• (è…¹éƒ¨æ¨æ“ )ã€‚",
                "<strong>æ„è­˜å–ªå¤±ï¼š</strong>1. å£“é¡æŠ¬ä¸‹å·´ -> å£“èƒ¸ (CPR 30:2)ã€‚2. çµ¦æ°£å‰<strong>ç›®è¦–</strong>å£ä¸­æœ‰ç„¡ç•°ç‰© (æœ‰æ‰æŒ–ï¼Œç¦ç›²ç›®æŒ–é™¤)ã€‚3. è‹¥ç„¡æ³•é€šæ°£ï¼ŒæŒçºŒ CPRã€‚"
            ],
            tp: {
                action: "Magill Forceps å¤¾é™¤",
                desc: "TP å¯ä½¿ç”¨å–‰é ­é¡ç›´è¦–å’½å–‰ï¼Œè‹¥æ¸…æ¥šçœ‹è¦‹ç•°ç‰©ï¼Œä½¿ç”¨ Magill Forceps å°‡å…¶å¤¾å‡ºã€‚æ³¨æ„æ“ä½œæ™‚å‹¿å°‡ç•°ç‰©æ¨å¾—æ›´æ·±ã€‚"
            }
        },
        {
            id: "Air-4", cat: "airway", title: "å‘¼å¸é“å››ï¼šå¬°å…’ç•°ç‰©å“½å¡ (<1æ­²)",
            flow: ["æ‹èƒŒå£“èƒ¸ (5:5)", "æ„è­˜å–ªå¤± CPR"],
            key: [
                "<strong>æ¸…é†’ï¼š</strong>5æ¬¡æ‹èƒŒ + 5æ¬¡å£“èƒ¸ (é ­ä½è…³é«˜)ã€‚",
                "<strong>æ„è­˜å–ªå¤±ï¼š</strong>CPR (30:2ï¼Œå–®æ‰‹å…©æŒ‡æ³•)ï¼Œæ¯æ¬¡å¹æ°£å‰æª¢æŸ¥å£è…”ã€‚"
            ],
            tp: null
        },
        {
            id: "Air-5", cat: "airway", title: "å‘¼å¸é“äº”ï¼šæ°£åˆ‡ç—…æ‚£å‘¼å¸å›°é›£",
            flow: ["è©•ä¼°æ»‘è„«/é˜»å¡", "æŠ½å¸/çµ¦æ°§"],
            key: [
                "<strong>é˜»å¡è©•ä¼°ï¼š</strong>è¡€æ°§ <94%ã€æ°£åˆ‡å£æœ‰ç—°éŸ³ã€‚",
                "<strong>æŠ½å¸ï¼š</strong>ç„¡èŒæŠ€è¡“æŠ½å¸ (æ·±åº¦7-12cm)ã€‚",
                "<strong>çµ¦æ°§ï¼š</strong>æ°£åˆ‡é¢ç½© æˆ– ç”¦é†’çƒæ¥æ°£åˆ‡å£ (è‹¥æœ‰æ°£å›Šéœ€å…ˆæŠ½æ°£æ‰å¯ç”±å£é¼»çµ¦æ°§)ã€‚"
            ],
            tp: {
                action: "ç§»é™¤æˆ–æ›´æ›æ°£åˆ‡",
                desc: "éœ€ç·šä¸Šé†«å›‘æˆæ¬Šã€‚è‹¥æ‚£è€… OHCA æˆ–å› å®Œå…¨é˜»å¡å±åŠç”Ÿå‘½ï¼ŒTP å¯ç§»é™¤æ°£åˆ‡ç®¡ï¼Œæ”¹æ’æ°£ç®¡å…§ç®¡ (ç¶“å£æˆ–ç¶“é€ å£) æˆ–ä½¿ç”¨ BVM é¢ç½©é€šæ°£ã€‚"
            }
        },
        {
            id: "Air-2", cat: "airway", title: "å‘¼å¸é“äºŒï¼šè²é–€ä¸Šå‘¼å¸é“ (SGA)",
            flow: ["OHCA/æ˜è¿·ä¸”ç„¡æ³•ç¶­æŒè¡€æ°§", "é¸æ“‡å°ºå¯¸", "æ½¤æ»‘ç½®å…¥", "é€šæ°£æ¸¬è©¦"],
            key: [
                "<strong>é©æ‡‰ç—‡ï¼š</strong>OHCA æˆ– GCS=3 ä¸” BVM çµ¦æ°§ç„¡æ•ˆ (SpO2 <90%)ã€‚",
                "<strong>ç¦å¿Œç—‡ï¼š</strong>æœ‰å˜”ååå°„ã€é£Ÿé“å¤–å‚·ã€ç•°ç‰©å“½å¡ã€‚",
                "<strong>å°ºå¯¸é¸æ“‡ (I-gel)ï¼š</strong>3è™Ÿ(30-60kg), 4è™Ÿ(50-90kg), 5è™Ÿ(>90kg)ã€‚"
            ],
            tp: null
        },
        {
            id: "Air-1", cat: "airway", title: "å‘¼å¸é“ä¸€ï¼šæ°£ç®¡å…§ç®¡æ’ç®¡ (ET)",
            flow: ["å‚™ç‰©", "é çµ¦æ°§", "æ’ç®¡", "ç¢ºèªä½ç½®", "å›ºå®š"],
            key: [
                "<strong>æ·±åº¦é¸æ“‡ (è·é–€é½’)ï¼š</strong>ç”·æ€§ 21-23 cmï¼Œå¥³æ€§ 19-21 cmã€‚å…’ç«¥ (å¹´é½¡/2)+12ã€‚",
                "<strong>ç¢ºèªï¼š</strong>è½è¨ºä¸Šè…¹éƒ¨(ç„¡è²)->è‚ºéƒ¨(å°ç¨±)ï¼ŒEtCO2ç›£æ¸¬ã€‚",
                "<strong>é™åˆ¶ï¼š</strong>å˜—è©¦<30ç§’ï¼Œå¤±æ•—æ”¹SGAã€‚"
            ],
            tp: {
                action: "TP å°ˆç”¨æŠ€è¡“",
                desc: "é©æ‡‰ç—‡ï¼šOHCAã€GCS=3 ä¸” BVM ç„¡æ³•æœ‰æ•ˆé€šæ°£ã€‚ç¦å¿Œï¼šæœ‰å–‰é ­åå°„ã€å¼µå£å›°é›£ã€‚",
                detail: "æ’ç®¡å¾Œé€šæ°£é€Ÿç‡ï¼šæ¯ 6 ç§’ 1 å£æ°£ (10æ¬¡/åˆ†)ã€‚EtCO2 ç›®æ¨™ 35-45 mmHgã€‚"
            }
        },

        // ====== å…§ç§‘ (Medical) ======
        {
            id: "Med-1", cat: "medical", title: "éå‰µå‚·ä¸€ï¼šOHCA (å¿ƒè·³åœæ­¢)",
            flow: ["CPR", "AED", "å‘¼å¸é“", "IV"],
            key: [
                "<strong>é«˜å“è³ª CPRï¼š</strong>æŒ‰å£“é€Ÿç‡ 100-120ï¼Œæ·±åº¦ 5-6cmã€‚",
                "<strong>AEDï¼š</strong>å„˜æ—©åˆ†æã€‚",
                "<strong>å‘¼å¸é“ï¼š</strong>ç½®å…¥ <strong>SGA</strong> æˆ–æ’ç®¡ã€‚",
                "<strong>IVï¼š</strong>å»ºç«‹éœè„ˆç®¡è·¯ (N/S)ã€‚"
            ],
            tp: {
                action: "é€²éšè—¥ç‰©è™•ç½®",
                drugs: [
                    { name: "Epinephrine", dose: "1 mg IV/IO", ind: "OHCA (ç„¡è„ˆæ)", warn: "æ¯ 4 åˆ†é˜çµ¦äºˆä¸€æ¬¡ã€‚" },
                    { name: "Amiodarone", dose: "300 mg / 150 mg", ind: "VF / ç„¡è„ˆæ€§ VT", warn: "æ¨æ³¨å¿«ï¼Œé–“éš” 3-5 åˆ†é˜ã€‚" }
                ]
            }
        },
        {
            id: "Med-2", cat: "medical", title: "éå‰µå‚·äºŒï¼šå‘¼å¸å›°é›£ (æ°£å–˜/COPD)",
            flow: ["è½è¨ºå“®é³´éŸ³", "å”åŠ©ç”¨è—¥", "çµ¦æ°§"],
            key: [
                "<strong>çµ¦æ°§ï¼š</strong>SpO2 ç¶­æŒ â‰¥94% (COPD ç¶­æŒ 88-92%)ã€‚",
                "<strong>å”åŠ©ç”¨è—¥ï¼š</strong>å”åŠ©ç—…æ‚£ä½¿ç”¨è‡ªå‚™ä¹‹ <strong>MDI (å®šé‡å™´éœ§åŠ‘)</strong>ã€‚",
                "<strong>å§¿å‹¢ï¼š</strong>åå§¿æˆ–åŠåè‡¥ã€‚"
            ],
            tp: {
                action: "æ°£éœ§æ²»ç™‚ (Combivent)",
                desc: "é©æ‡‰ç—‡ï¼š1æ­²ä»¥ä¸Šï¼Œç„¡å¿ƒè‚Œæ¢—å¡ç—…å²ï¼›ç„¡è‡ªå‚™è—¥ç‰©ç„¡æ•ˆã€‚é…æ–¹ï¼šCombiventã€‚æµé€Ÿ 6 L/minã€‚",
                drugs: []
            }
        },
        {
            id: "Med-3", cat: "medical", title: "éå‰µå‚·ä¸‰ï¼šæ„è­˜ä¸æ¸… / ä½è¡€ç³–",
            flow: ["æ¸¬è¡€ç³–", "æ’é™¤ä½è¡€ç³–", "è©•ä¼°å…¶ä»–åŸå› "],
            key: [
                "<strong>ä½è¡€ç³– (<60 mg/dl)ï¼š</strong><br>1. æ¸…é†’ï¼šå£æœè‘¡è„ç³–/ç³–ç²‰ã€‚<br>2. æ„è­˜ä¸æ¸…ï¼šç”± IV çµ¦äºˆ <strong>D5W (5%è‘¡è„ç³–æ¶²)</strong>ã€‚"
            ],
            tp: {
                action: "éœè„ˆæ³¨å°„è‘¡è„ç³–",
                drugs: [
                    { name: "D50W", dose: "2-4 amp IV æ¨æ³¨", ind: "ä½è¡€ç³–æ˜è¿·", warn: "ç¢ºèªç®¡è·¯æš¢é€šã€‚" }
                ]
            }
        },
        {
            id: "Med-4", cat: "medical", title: "éå‰µå‚·å››ï¼šæŠ½æ (Seizure)",
            flow: ["ä¿è­·æ‚£è€…", "å‘¼å¸é“/çµ¦æ°§", "æ¸¬è¡€ç³–"],
            key: [
                "<strong>ä¿è­·ï¼š</strong>ç§»é–‹å±éšªç‰©ï¼Œå‹¿å¼·å¡ç‰©å“å…¥å£ã€‚",
                "<strong>çµ¦æ°§ï¼š</strong>ç¶­æŒ SpO2 â‰¥94%ã€‚",
                "<strong>è¡€ç³–ï¼š</strong>è‹¥ <60 ä¸”å·²è¨­ IVï¼Œå¯çµ¦ <strong>D5W</strong> (è‹¥èºå‹•å±éšªå‰‡ä¸å‹‰å¼·æ‰“é‡)ã€‚"
            ],
            tp: {
                action: "è—¥ç‰©æ²»ç™‚",
                desc: "è‹¥ç‚ºç™²ç™‡é‡ç©ç‹€æ…‹ï¼Œéƒ¨åˆ†ç¸£å¸‚ TP å¯ä¾é†«å›‘çµ¦äºˆ Midazolam IMã€‚"
            }
        },
        {
            id: "Med-5", cat: "medical", title: "éå‰µå‚·äº”ï¼šè‡´å‘½æ€§éæ• (Anaphylaxis)",
            flow: ["è©•ä¼°ä¼‘å…‹/å–˜é³´", "å”åŠ© EpiPen", "è¼¸æ¶²"],
            key: [
                "<strong>å”åŠ©ç”¨è—¥ï¼š</strong>å”åŠ©ç—…æ‚£ä½¿ç”¨ <strong>EpiPen</strong> æ–¼å¤§è…¿å¤–å´ã€‚",
                "<strong>è¼¸æ¶²ï¼š</strong>è‹¥ä¼‘å…‹ (SBP <90)ï¼ŒIV çµ¦äºˆ N/S æŒ‘æˆ°ã€‚"
            ],
            tp: {
                action: "IM çµ¦è—¥",
                drugs: [
                    { name: "Epinephrine (1:1000)", dose: "æˆäºº 0.3-0.5 mg IM", ind: "éæ•æ€§ä¼‘å…‹", warn: "æ¯ 5-15 åˆ†é˜å¯é‡è¤‡ã€‚" }
                ]
            }
        },
        {
            id: "Med-6", cat: "medical", title: "éå‰µå‚·å…­ï¼šç–‘ä¼¼è…¦ä¸­é¢¨ (CVA)",
            flow: ["è¾›è¾›é‚£æ (FAST)", "å‡è¦–æ¸¬è©¦ (G-FAST)", "é€é†«"],
            key: [
                "<strong>è©•ä¼°ï¼š</strong>FAST (è‡‰ã€æ‰‹ã€èªã€æ™‚é–“) + G-FAST (çœ¼çƒå‡è¦–åæ–œ)ã€‚",
                "<strong>è™•ç½®ï¼š</strong>é ­éƒ¨æŠ¬é«˜ 30 åº¦ï¼Œç¶­æŒ SpO2 â‰¥94%ï¼Œç¦é£Ÿï¼Œæ¸¬è¡€ç³–æ’é™¤ä½è¡€ç³–ã€‚"
            ],
            tp: null
        },
        {
            id: "Med-7", cat: "medical", title: "éå‰µå‚·ä¸ƒï¼šç¼ºè¡€æ€§èƒ¸ç—› (ACS)",
            flow: ["12å°ç¨‹ ECG", "å”åŠ© NTG"],
            key: [
                "<strong>æª¢æŸ¥ï¼š</strong>åŸ·è¡Œ <strong>12-Lead ECG</strong>ã€‚",
                "<strong>å”åŠ©ç”¨è—¥ (NTG)ï¼š</strong><br>æ¢ä»¶ï¼šSBP >90ã€HR 50-100ã€ç„¡æœç”¨å£¯é™½è—¥ (å¨24h/çŠ€48h)ã€ç„¡å³å¿ƒæ¢—å¡å¾µè±¡ã€‚<br>ç”¨æ³•ï¼šèˆŒä¸‹å«æœï¼Œæ¯ 5 åˆ†é˜ 1 é¡† (Max 3æ¬¡)ã€‚"
            ],
            tp: {
                action: "MONA æ²»ç™‚",
                drugs: [
                    { name: "Aspirin", dose: "300 mg å£æœ", ind: "ç–‘ä¼¼ AMI", warn: "æ’é™¤éæ•/å‡ºè¡€ã€‚" },
                    { name: "NTG", dose: "èˆŒä¸‹ 1 é¡†", ind: "å¿ƒçµç—›", warn: "åš´å®ˆç¦å¿Œã€‚" }
                ]
            }
        },
        {
            id: "Med-8", 
            cat: "medical", 
            title: "éå‰µå‚·å…«ï¼šæ€¥æ€§å¿ƒè‡Ÿè¡°ç«­ (AHF)",
            flow: ["è¾¨è­˜ AHF (å–˜/è…«/JVD)", "R-V-P è©•ä¼° (Rate/Vol/Pump)", "æ’é™¤ç¦å¿Œçµ¦ NTG", "TP å¿ƒç‡æ§åˆ¶"],
            key: [
                "<strong>ğŸš¨ é—œéµè¾¨è­˜ (Signs)ï¼š</strong><br>ä¸»è¨´ï¼šå‘¼å¸å–˜ã€ç«¯åå‘¼å¸(èººå¹³æ›´å–˜)ã€èƒ¸æ‚¶ã€‚<br>è¦–è¨ºï¼šé ¸éœè„ˆæ€’å¼µ (JVD)ã€è…³è…«ã€ç™¼ç´ºã€‚<br>è½è¨ºï¼šé›™å´è‚ºéƒ¨æ¿•å›‰éŸ³ (Crackles)ã€‚<br>è§¸è¨ºï¼šä¸‹è‚¢å‡¹é™·æ€§æ°´è…«ã€çš®è†šæ¿•å†·(è‹¥ä¼‘å…‹)ã€‚",
                "<strong>âš¡ R-V-P è©•ä¼°åŸå‰‡ (ç”±ä¸Šè€Œä¸‹)ï¼š</strong><br>1. <strong>Rate (å¿ƒç‡)ï¼š</strong>ç¢ºèªè„ˆæ >150 æˆ– <50ï¼Ÿè‹¥æœ‰ï¼Œå„ªå…ˆè™•ç†(è¦‹TP)ã€‚<br>2. <strong>Volume (é«”æ¶²)ï¼š</strong>SBP < 90 ä¸”è„«æ°´(é»è†œä¹¾/çš®è†šå¼µåŠ›å·®)ï¼Ÿçµ¦ N/S 250mlã€‚<br>3. <strong>Pump (å¹«æµ¦)ï¼š</strong>SBP > 90 ä¸”è‚ºæ°´è…«(æ¿•å›‰éŸ³)ï¼Ÿçµ¦ NTGã€‚",
                "<strong>ğŸ’Š Pump è™•ç½® (NTG)ï¼š</strong><br>åŠ‘é‡ï¼šèˆŒä¸‹ 1 é¡† (æ¯ 5 åˆ†é˜ 1 æ¬¡ï¼ŒMax 3æ¬¡)ã€‚<br>ç¦å¿Œï¼šå³å¿ƒæ¢—å¡ã€å¨çˆ¾é‹¼(24h)/çŠ€åˆ©å£«(48h)ã€HR <50 æˆ– >100ã€‚"
            ],
            tp: {
                action: "å¿ƒç‡ç•°å¸¸ CHECK LIST",
                desc: "è„ˆæ < 50 æˆ– > 150 ä¸”è¾¨è­˜ç‚º AHF æ™‚é©ç”¨",
                drugs: [
                    {
                        name: "ğŸ“‰ ç·©è„ˆ (< 50 bpm)",
                        dose: "Atropine 1mg IV",
                        ind: "ä¸ç©©å®š (ä¼‘å…‹/æ„è­˜ä¸æ¸…)",
                        warn: "ç„¡æ•ˆï¼šTCP (å‰å¾Œè²¼/Demand/70bpm/40mAèµ·)ã€‚ç©©å®šï¼šåƒ…ç›£æ¸¬ã€‚"
                    },
                    {
                        name: "ğŸ“ˆ é »è„ˆ (> 150 bpm)",
                        dose: "åŒæ­¥æ•´æµ (ç·šä¸Šé†«å›‘)",
                        ind: "ä¸ç©©å®š (ä¼‘å…‹/æ„è­˜ä¸æ¸…)",
                        warn: "çª„è¦å‰‡ 50-100J / å¯¬è¦å‰‡ 100J / ä¸è¦å‰‡ 120-200Jã€‚ç©©å®šçª„QRSï¼šè¿·èµ°ç¥ç¶“åˆºæ¿€ã€‚"
                    }
                ]
            }
        },
        {
            id: "Med-9", cat: "medical", title: "éå‰µå‚·ä¹ï¼šéå‰µå‚·ä¼‘å…‹",
            flow: ["è©•ä¼°çŒæµ (æ„è­˜/è†šè‰²/CRT)", "è¼¸æ¶²", "ä¿æš–"],
            key: [
                "<strong>è™•ç½®ï¼š</strong>çµ¦æ°§ã€ä¿æš–ã€æŠ¬é«˜ä¸‹è‚¢ã€IV è¼¸æ¶² (N/S)ã€‚"
            ],
            tp: null
        },

        // ====== å‰µå‚· (Trauma) ======
        {
            id: "Tra-2", cat: "trauma", title: "å‰µå‚·äºŒï¼šé ­éƒ¨å¤–å‚·",
            flow: ["GCS", "é ¸æ¤ä¿è­·", "è…¦ç–å¾µè±¡"],
            key: [
                "<strong>IICP å¾µè±¡ï¼š</strong>è¡€å£“é«˜ã€å¿ƒè·³æ…¢ã€å‘¼å¸ä¸è¦å‰‡ (Cushing's triad)ã€‚",
                "<strong>è™•ç½®ï¼š</strong>é ¸æ¤é™åˆ¶ (é•·èƒŒæ¿/é ¸åœˆ)ï¼Œé ­éƒ¨æŠ¬é«˜ 30 åº¦ã€‚",
                "<strong>æ›æ°£ï¼š</strong>è‹¥è…¦ç–è„«ï¼ŒBVM è¼•åº¦éåº¦æ›æ°£ (æˆäºº20æ¬¡/åˆ†)ã€‚"
            ],
            tp: {
                action: "æ°£é“ç®¡ç†",
                desc: "è‹¥ GCS < 9 ä¸”ç„¡æ³•ç¶­æŒå‘¼å¸é“ï¼ŒTP æ‡‰è€ƒæ…®æ’ç®¡ä¿è­·å‘¼å¸é“ã€‚"
            }
        },
        {
            id: "Tra-3", cat: "trauma", title: "å‰µå‚·ä¸‰ï¼šèƒ¸éƒ¨å¤–å‚· (æ°£èƒ¸)",
            flow: ["å°é–‰å‚·å£", "çµ¦æ°§"],
            key: [
                "<strong>é–‹æ”¾æ€§æ°£èƒ¸ï¼š</strong>ä¸‰é¢è²¼ç´® (æˆ–ä¸é€æ°£æ•·æ–™)ã€‚",
                "<strong>ç©¿åˆºç‰©ï¼š</strong>å›ºå®šä¸æ‹”é™¤ã€‚",
                "<strong>å¼µåŠ›æ€§æ°£èƒ¸å¾µè±¡ï¼š</strong>å–®å´å‘¼å¸éŸ³æ¶ˆå¤±+ä¼‘å…‹+JVD -> çµ¦äºˆé«˜æ¿ƒåº¦æ°§æ°£ã€‚"
            ],
            tp: {
                action: "é‡åˆºæ¸›å£“",
                desc: "é©æ‡‰ç—‡ï¼šå¼µåŠ›æ€§æ°£èƒ¸ + ä¼‘å…‹/ç€•æ­»ã€‚"
            }
        },
        {
            id: "Tra-4", cat: "trauma", title: "å‰µå‚·å››ï¼šè…¹éƒ¨å¤–å‚·",
            flow: ["å¤–éœ²è™•ç†", "å›ºå®šç©¿åˆºç‰©", "éª¨ç›†å›ºå®š"],
            key: [
                "<strong>è‡Ÿå™¨å¤–éœ²ï¼š</strong>æ¿•ç´—è¦†è“‹ã€åŒ…ç´® (ä¸å¯å¡å›)ã€‚",
                "<strong>éª¨ç›†éª¨æŠ˜ï¼š</strong>ä½¿ç”¨éª¨ç›†å›ºå®šå¸¶ (Binder)ã€‚"
            ],
            tp: null
        },
        {
            id: "Tra-5", cat: "trauma", title: "å‰µå‚·äº”ï¼šè‚¢é«”å¤–å‚· / æ–·è‚¢",
            flow: ["æ­¢è¡€", "å›ºå®š", "æ–·è‚¢ä¿å­˜"],
            key: [
                "<strong>å¤§å‡ºè¡€ï¼š</strong>ç›´æ¥åŠ å£“ -> ç„¡æ•ˆå‰‡ä½¿ç”¨ <strong>æ­¢è¡€å¸¶ (Tourniquet)</strong> (é«˜ä½æˆ–å‚·å£ä¸Š5-8cm)ã€‚",
                "<strong>æ–·è‚¢ï¼š</strong>æ¿•ç´—åŒ…è¦† -> è£å¡‘è† è¢‹ -> ç½®å…¥å†°æ°´è¢‹ (éš”æ°´ä¿å†°)ã€‚"
            ],
            tp: null
        },
        {
            id: "Tra-6", cat: "trauma", title: "å‰µå‚·å…­ï¼šå‡ºè¡€æ€§ä¼‘å…‹",
            flow: ["æ­¢è¡€", "é™åˆ¶æ€§è¼¸æ¶²"],
            key: [
                "<strong>è¼¸æ¶²ï¼š</strong>IV N/Sã€‚",
                "<strong>ç›®æ¨™è¡€å£“ï¼š</strong><br>ä¸€èˆ¬å‰µå‚·ï¼šç¶­æŒ SBP <strong>90 mmHg</strong> (æ‘¸å¾—åˆ°æ©ˆå‹•è„ˆ)ã€‚<br>åˆä½µ TBI (è…¦å‚·)ï¼šç¶­æŒ SBP <strong>110 mmHg</strong>ã€‚"
            ],
            tp: {
                action: "Tranexamic Acid (TXA)",
                drugs: [
                    { name: "TXA", dose: "1 g (åŠ å…¥ 100ml N/S)", ind: "åš´é‡å‡ºè¡€æ€§ä¼‘å…‹ (å‚·å¾Œ3å°æ™‚å…§)", warn: "éœ€ç·šä¸Šé†«å›‘ã€‚æ»´æ³¨ > 10 åˆ†é˜ã€‚" }
                ]
            }
        },

        // ====== ç‰¹æ®Š (Special) ======
        {
            id: "Sp-1", cat: "special", title: "ç‰¹æ®Šä¸€ï¼šç«å ´æ•‘å‡º / å¸å…¥æ€§ç¼å‚·",
            flow: ["çµ¦æ°§ (ä¸€å¾‹é«˜æ¿ƒåº¦)", "è©•ä¼°æ°£é“"],
            key: [
                "<strong>çµ¦æ°§ï¼š</strong><strong>NRM 15L/min</strong> (æ‡·ç–‘ CO ä¸­æ¯’)ã€‚",
                "<strong>å¸å…¥æ€§ç¼å‚·ï¼š</strong>é¼»æ¯›ç„¦ã€ç—°æœ‰ç¢³ç²’ã€è²éŸ³æ²™å• -> æº–å‚™ BVMã€‚"
            ],
            tp: {
                action: "é é˜²æ€§æ’ç®¡ & æ°£éœ§æ²»ç™‚",
                desc: "1. é é˜²æ€§æ’ç®¡ï¼šå‘¼å¸é“æ°´è…«æƒ¡åŒ–å¿«ã€‚<br>2. è…ä¸Šè…ºç´ æ°£éœ§æ²»ç™‚ (Epi 1mg + 3ml N/S, 6L/min)ã€‚"
            }
        },
        {
            id: "Sp-2", cat: "special", title: "ç‰¹æ®ŠäºŒï¼šç¼ç‡™å‚·",
            flow: ["æ²–æ°´", "è¦†è“‹", "è¼¸æ¶²"],
            key: [
                "<strong>å‚·å£ï¼š</strong>æ²–æ°´ 15 åˆ†é˜ (ä¸å¯å†°æ•·)ï¼Œç§»é™¤é£¾å“ï¼Œç„¡èŒç´—å¸ƒè¦†è“‹ã€‚",
                "<strong>è¼¸æ¶² (Parkland)ï¼š</strong>æˆäºº 2ml x kg x % (å‰8å°æ™‚çµ¦ä¸€åŠ)ã€‚"
            ],
            tp: {
                action: "è…ä¸Šè…ºç´ æ°£éœ§æ²»ç™‚",
                desc: "é‡å°ä¼´éš¨ä¸Šå‘¼å¸é“æ°´è…«å¾µè±¡ã€‚"
            }
        },
        {
            id: "Sp-3", cat: "special", title: "ç‰¹æ®Šä¸‰ï¼šæººæ°´",
            flow: ["C-spine (åƒ…é«˜é¢¨éšª)", "ä¿æš–", "çµ¦æ°§"],
            key: [
                "<strong>C-spineï¼š</strong>é™¤éè·³æ°´/æ’æ“Šï¼Œå¦å‰‡ä¸éœ€å¸¸è¦é ¸æ¤é™åˆ¶ã€‚",
                "<strong>è™•ç½®ï¼š</strong>æ“¦ä¹¾ä¿æš–ï¼Œçµ¦æ°§ (é é˜²å»¶é²æ€§è‚ºæ°´è…«)ã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-4", cat: "special", title: "ç‰¹æ®Šå››ï¼šä¸­æ¯’ (æœ‰æ©Ÿç£·/è—¥ç‰©)",
            flow: ["é™¤æ±™", "æ”¶é›†æ¯’ç‰©", "è¾¨è­˜ç—‡ç‹€"],
            key: [
                "<strong>é™¤æ±™ï¼š</strong>ç§»é™¤è¡£ç‰©ã€æ²–æ´—ã€‚",
                "<strong>æœ‰æ©Ÿç£·ç—‡ç‹€ï¼š</strong>æµæ·šã€æµå£æ°´ã€ç¸®ç³ (SLUDGE)ã€‚",
                "<strong>æ¯’è—¥ç‰©ï¼š</strong>æ”¶é›†è—¥ç“¶å¸¶è‡³é†«é™¢ã€‚"
            ],
            tp: {
                action: "è§£æ¯’åŠ‘",
                drugs: [
                    { name: "Atropine", dose: "1-2 mg IV", ind: "æœ‰æ©Ÿç£·ä¸­æ¯’ä¼´éš¨åš´é‡ç—‡ç‹€", warn: "é‡è¤‡çµ¦äºˆè‡³å£æ°´æ¸›å°‘ã€‚" }
                ]
            }
        },
        {
            id: "Sp-5", cat: "special", title: "ç‰¹æ®Šäº”ï¼šæ€¥ç”¢ / æ–°ç”Ÿå…’",
            flow: ["æ¥ç”Ÿ", "æ–·è‡ (åƒ…å¿…è¦æ™‚)", "æ–°ç”Ÿå…’è©•ä¼°"],
            key: [
                "<strong>æ¥ç”Ÿï¼š</strong>ä¿è­·æœƒé™°ï¼Œä¸éš¨æ„æ–·è‡ (é™¤éç¹é ¸ç„¡æ³•è§£/éœ€æ€¥æ•‘)ã€‚",
                "<strong>æ–°ç”Ÿå…’ (HR<100)ï¼š</strong>æ­£å£“çµ¦æ°§ (BVM)ã€‚",
                "<strong>æ–°ç”Ÿå…’ (HR<60)ï¼š</strong>CPR (3:1)ã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-6", cat: "special", title: "ç‰¹æ®Šå…­ï¼šå­•å©¦æ€¥ç—‡",
            flow: ["å·¦å´èºº", "è©•ä¼°å…©åæ‚£è€…"],
            key: [
                "<strong>å§¿å‹¢ï¼š</strong><strong>å·¦å´èºº</strong> (é¿å…å£“è¿«ä¸‹è…”éœè„ˆ)ã€‚",
                "<strong>OHCAï¼š</strong>CPR æ™‚å°‡å­å®®æ¨å‘å·¦å´ã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-8", cat: "special", title: "ç‰¹æ®Šå…«ï¼šå°å…’è©•ä¼° (Pediatric)",
            flow: ["è©•ä¼°ä¸‰è§’ (PAT)", "Peds CPR"],
            key: [
                "<strong>PAT ä¸‰è§’ï¼š</strong>å¤–è§€ (Appearance)ã€å‘¼å¸ (Breathing)ã€å¾ªç’° (Circulation)ã€‚",
                "<strong>CPRï¼š</strong>è„ˆæ <60 ä¸”çŒæµå·® -> CPRã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-11", cat: "special", title: "ç‰¹æ®Šåä¸€ï¼šå¾©ç”¦å¾Œç…§è­· (ROSC)",
            flow: ["12-lead ECG", "ç¶­æŒ SpO2/BP"],
            key: [
                "<strong>å‘¼å¸ï¼š</strong>SpO2 ç¶­æŒ 92-98%ï¼Œé¿å…éåº¦æ›æ°£ã€‚",
                "<strong>å¾ªç’°ï¼š</strong>SBP ç¶­æŒ >90 mmHg ã€‚",
                "<strong>æª¢æŸ¥ï¼š</strong>12-Lead ECG ã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-9", cat: "special", title: "ç‰¹æ®Šä¹ï¼š(ç–‘ä¼¼)ç²¾ç¥ç•°å¸¸èˆ‡è¡Œç‚ºæ€¥ç—‡",
            flow: ["ç¾å ´å®‰å…¨ç¢ºèª", "åˆæ­¥è©•ä¼°", "åˆ¤æ–·æ˜¯å¦éœ€å¼·åˆ¶å°±é†«"],
            key: [
                "<strong>å®‰å…¨ç¬¬ä¸€ï¼š</strong>ç¢ºèªå“¡è­¦å·²åˆ°å ´ã€‚ä¿æŒè·é›¢ã€å´èº«é˜²ç¦¦å§¿å‹¢ã€ä¸ç«™æ­»è§’ã€ä¸è¨€èªåˆºæ¿€ã€‚",
                "<strong>å¼·åˆ¶å°±é†«åˆ¤æ–·ï¼š</strong><br>1. æœ‰è‡ªå‚·/å‚·äººçš†å±¬ç²¾ç¥ç—…äººï¼šå”åŠ©è­·é€ã€‚<br>2. èº«åˆ†ä¸æ˜/éç¾è¡ŒçŠ¯ï¼šéœ€è¡›ç”Ÿå±€äººå“¡åˆ°å ´ã€‚<br>3. å–®ç´”æ»‹æ“¾ï¼šäº¤ç”±è­¦å¯Ÿè™•ç† (ç¤¾ç¶­æ³•)ã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-10", cat: "special", title: "ç‰¹æ®Šåï¼šå¤§é‡å‚·æ‚£äº‹æ•… (MCI)",
            flow: ["ç¢ºèªäººæ•¸", "å›å ±å•Ÿå‹•", "æª¢å‚·åˆ†é¡", "åˆ†æµå¾Œé€"],
            key: [
                "<strong>START æª¢å‚·æ³• (æˆäºº)ï¼š</strong><br>1. ç¶  (è¼•å‚·)ï¼šèƒ½è¡Œèµ°è€…ã€‚<br>2. ç´… (æ¥µå±éšª)ï¼šå‘¼å¸>30æˆ–<10ã€ç„¡æ©ˆå‹•è„ˆã€ç„¡æ³•è½å¾æŒ‡ä»¤ã€‚<br>3. é»ƒ (ä¸­å‚·)ï¼šä¸èƒ½è¡Œèµ°ï¼Œä½†ABCæ­£å¸¸ã€‚<br>4. é»‘ (æ­»äº¡)ï¼šæš¢é€šå‘¼å¸é“å¾Œä»ç„¡å‘¼å¸ã€‚",
                "<strong>T2 ç¾å ´è™•ç½®ï¼š</strong>æª¢å‚·æ™‚åƒ…åš <strong>ã€Œæš¢é€šå‘¼å¸é“ã€</strong> èˆ‡ <strong>ã€Œæ­¢è¡€ã€</strong>ã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-13", cat: "special", title: "ç‰¹æ®Šåä¸‰ï¼šç¾å ´æ­»äº¡ / DNR / æ‹’é€",
            flow: ["ç¢ºèªç”Ÿå‘½å¾µè±¡", "æª¢æŸ¥è­‰ä»¶/å±é«”ç‹€æ…‹", "è™•ç½®æˆ–äº¤å‹¤"],
            key: [
                "<strong>ä¸æ–½è¡Œ CPR (DNR)ï¼š</strong>éœ€å‡ºç¤ºã€Œé ç«‹é†«ç™‚æ±ºå®šæ›¸ã€æˆ–å®¶å±¬ç°½ç½²ã€ŒDNR åŒæ„æ›¸/æ‹’çµ•æ•‘è­·ã€ã€‚",
                "<strong>ç¾å ´æ­»äº¡ (DOA)ï¼š</strong>æ¢ä»¶ï¼šå±è…ã€å±åƒµ (å¸¸æº«ä¸‹)ã€å±é«”ç„¦é»‘ã€ç„¡é¦–ã€å…§è‡Ÿå¤–æº¢ã€è»€å¹¹æ–·é«”ã€‚",
                "<strong>æ‹’çµ•é€é†«ï¼š</strong>å‘ŠçŸ¥åš´é‡å¾Œæœ -> æ¸¬é‡ç”Ÿå‘½å¾µè±¡ -> ç°½ååˆ‡çµã€‚"
            ],
            tp: null
        },
        {
            id: "Sp-15", cat: "special", title: "ç‰¹æ®Šåäº”ï¼šé‡å¤–èˆ‡é•·é€”å°±é†« (>1å°æ™‚)",
            content: `
                <div class="sec-header">ğŸŒ² é‡å¤–èˆ‡é•·é€”å°±é†« (Transport > 1å°æ™‚)</div>

                <details class="sp-detail" onclick="event.stopPropagation()">
                    <summary><span class="tag-block tag-red">30</span> é‡å¤–å‰µå‚·èˆ‡æ­¢è¡€</summary>
                    <div class="sp-content">
                        <strong>æ­¢è¡€å¸¶ (Tourniquet)ï¼š</strong><br>
                        â€¢ è‹¥é ä¼°é‹é€ >2å°æ™‚ï¼Œå„ªå…ˆç¶åœ¨å‚·å£è¿‘å¿ƒç«¯ 5-8 cm (éé—œç¯€è™•)ã€‚<br>
                        â€¢ è‹¥ >2å°æ™‚å¯å˜—è©¦æ›æˆåŠ å£“åŒ…ç´® (ä½†åœ¨ä¼‘å…‹/æˆªè‚¢/ç„¡æ³•ç›£æ§æ™‚ä¸å¯ç§»é™¤)ã€‚<br>
                        <strong>å‚·å£æ¸…æ´—ï¼š</strong>å¯ç”¨é£²ç”¨æ°´æ²–æ´—å‚·å£ï¼Œç¢ºèªå‡ºè¡€é»å¾Œå†ç²¾æº–åŠ å£“ã€‚<br>
                        <strong>æ–·è‚¢ä¿å­˜ï¼š</strong>ç„¡å†°å¡Šæ™‚ï¼Œå¯ç”¨æ¿•æ¯›å·¾/è¡£ç‰©åŒ…è¦†å…§è¢‹ï¼Œé¿å…ç›´æ¥æ³¡æ°´ã€‚
                    </div>
                </details>

                <details class="sp-detail" onclick="event.stopPropagation()">
                    <summary><span class="tag-block tag-green">31</span> é‡å¤–è„Šæ¤èˆ‡éª¨éª¼å‚·å®³</summary>
                    <div class="sp-content">
                        <strong>è„Šæ¤æª¢æ¸¬ (é€šéå¯ä¸å›ºå®š)ï¼š</strong><br>
                        1. æ„è­˜æ¸…é†’ä¸”å¯é  (ç„¡å–é…’/è—¥ç‰©/åŠ‡ç—›å¹²æ“¾)ã€‚<br>
                        2. ç„¡è„Šæ¤å£“ç—›ã€‚<br>
                        3. ç„¡ç¥ç¶“å­¸ç•°å¸¸ (å››è‚¢éº»æœ¨/ç„¡åŠ›)ã€‚<br>
                        4. ç„¡åˆ†å¿ƒæ€§ç–¼ç—›ã€‚<br>
                        <strong>é•·éª¨éª¨æŠ˜ï¼š</strong>ä¸è«–ç¥ç¶“è¡€ç®¡æ˜¯å¦å—æï¼Œçš†é€²è¡Œ <strong>ã€Œç‰½å¼•å¾©ä½ã€</strong> å¾Œå›ºå®š (é‡åŠ‡ç—›é˜»åŠ›å‰‡åœæ­¢)ã€‚<br>
                        <strong>è„«è‡¼ï¼š</strong>åŸå§¿å‹¢å›ºå®šï¼›è‹¥é ç«¯ç„¡è„ˆæï¼Œå¯å˜—è©¦å¾©ä½ (ä¸­æ®µå¡ä½å‰‡åœ)ã€‚
                    </div>
                </details>

                <details class="sp-detail" onclick="event.stopPropagation()">
                    <summary><span class="tag-block tag-blue">32</span> é‡å¤–ç’°å¢ƒæ€¥ç—‡ (é«˜å±±/ç†±/å†·)</summary>
                    <div class="sp-content">
                        <strong>æ€¥æ€§é«˜å±±ç—‡ (AMS)ï¼š</strong>é ­ç—› + (å™å¿ƒ/ç–²å€¦/é ­æšˆ)ã€‚è™•ç½®ï¼šåœæ­¢ä¸Šå‡ã€çµ¦æ°§ã€ä¸‹é™é«˜åº¦ã€‚<br>
                        <strong>é«˜æµ·æ‹”è‚ºæ°´è…« (HAPE)ï¼š</strong>ä¼‘æ¯æ™‚å–˜ã€æ¿•å›‰éŸ³ã€ç²‰ç´…æ³¡æ²«ç—°ã€‚è™•ç½®ï¼šä¸‹é™é«˜åº¦ã€çµ¦æ°§ã€ä¿æš–ã€‚<br>
                        <strong>ç†±æ€¥ç—‡ (ä¸­æš‘)ï¼š</strong>ç›®æ¨™30åˆ†é˜å…§é™æº«è‡³39åº¦ã€‚æ–¹æ³•ï¼šæµ¸æ³¡æºªæ°´/å†·æ°´ (é ­éƒ¨éœ²å‡º)ã€‚<br>
                        <strong>å¤±æº« (Hypothermia)ï¼š</strong><br>
                        â€¢ è¼•åº¦ (æœƒç™¼æŠ–)ï¼šé€²é£Ÿç†±ç³–æ°´ã€æ›´æ›ä¹¾è¡£ã€‚<br>
                        â€¢ é‡åº¦ (ä¸ç™¼æŠ–/æ„è­˜ä¸æ¸…)ï¼š<strong>ä¸å¯</strong>ä¸»å‹•åŠ ç†±å››è‚¢ (é˜²å¾©æº«ä¼‘å…‹)ï¼Œæ¡ã€Œä½æº«åŒ…è£¹ã€(é˜²æ°´å±¤+ä¿æš–å±¤) é™åˆ¶ç§»å‹•ï¼Œå„˜é€Ÿå¾Œé€ã€‚
                    </div>
                </details>

                <details class="sp-detail" onclick="event.stopPropagation()">
                    <summary><span class="tag-block tag-orange">33</span> ç”Ÿç‰©å’¬å‚· (è›‡/èœ‚)</summary>
                    <div class="sp-content">
                        <strong>è›‡å’¬ï¼š</strong><br>
                        â€¢ <strong>ç¦å¿Œï¼š</strong>ä¸å¯åˆ‡é–‹ã€ä¸å¯å¸å®ã€<strong>ä¸å¯ä½¿ç”¨æ­¢è¡€å¸¶</strong>ã€ä¸å¯å†°æ•·ã€‚<br>
                        â€¢ è™•ç½®ï¼šè„«é™¤é£¾å“ï¼Œè‚¢é«”æ”¾ä½ (ä½æ–¼å¿ƒè‡Ÿ)ï¼Œç•«åœˆæ¨™è¨˜è…«è„¹ç¯„åœ (æ¯15åˆ†ä¸€æ¬¡)ï¼Œå½ˆç¹ƒåŒ…ç´® (å£“åŠ›åŒæ‰­å‚·å³å¯)ã€‚<br>
                        <strong>åš´é‡éæ• (Anaphylaxis)ï¼š</strong><br>
                        â€¢ è‹¥å‡ºç¾å‘¼å¸å›°é›£/ä¼‘å…‹ï¼ŒT2 å¯å”åŠ©ä½¿ç”¨ <strong>EpiPen</strong> (å¤§è…¿å¤–å´)ã€‚
                    </div>
                </details>
            `,
            tp: null
        },
        {
            id: "Sp-16", cat: "special", title: "ç‰¹æ®Šåå…­ï¼šé«˜å¨è„…ç’°å¢ƒæ•‘è­·",
            flow: ["å»ºç«‹å†·/æš–/ç†±å€", "æ©è­·", "é—œéµè™•ç½®"],
            key: [
                "<strong>ç†±å€ (Hot Zone/ç›´çƒå°æ±º)ï¼š</strong>æœ‰ç«‹å³å¨è„…ã€‚è™•ç½®ï¼š<strong>åƒ…åšæ­¢è¡€å¸¶æ­¢è¡€</strong> (Exsanguination control)ï¼Œä¸¦å¿«é€Ÿæ‹‰å‡º/æ’¤é›¢ï¼Œå…¶é¤˜ä¸åšã€‚",
                "<strong>æš–å€ (Warm Zone/æ½›åœ¨å¨è„…)ï¼š</strong>å¨è„…æš«æ™‚æ§åˆ¶ã€‚è™•ç½®ï¼šå¿«é€ŸåŸ·è¡Œ XABC (å¤§é‡å‡ºè¡€ã€å‘¼å¸é“ã€å‘¼å¸ã€å¾ªç’°)ï¼Œä¸é€²è¡Œç´°è†©è™•ç½®ã€‚",
                "<strong>å†·å€ (Cold Zone)ï¼š</strong>ç›¸å°å®‰å…¨ã€‚è™•ç½®ï¼šåŸ·è¡Œå®Œæ•´è©•ä¼°èˆ‡ä¸€èˆ¬æ•‘è­·æµç¨‹ã€‚"
            ],
            tp: null
        },

        // ... (Tutorials) ...
        { id: "TUT-1", cat: "tutorial", title: "ğŸ iOS (iPhone) æ‰‹æ©Ÿå®‰è£æ•™å­¸", content: `<div class="tut-step"><strong>1. é–‹å•Ÿæª”æ¡ˆï¼š</strong><br>å‹™å¿…ä½¿ç”¨ <strong>Safari</strong>ã€‚</div><div class="tut-step"><strong>2. é»æ“Šåˆ†äº«ï¼š</strong><br>é»æ“Šè¢å¹•ä¸‹æ–¹ <span style="font-size:1.2rem">ğŸ“¤</span>ã€‚</div><div class="tut-step"><strong>3. åŠ å…¥ä¸»ç•«é¢ï¼š</strong><br>é¸æ“‡ <strong>ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</strong>ã€‚</div>`, tp: null },
        { id: "TUT-2", cat: "tutorial", title: "ğŸ¤– Android æ‰‹æ©Ÿå®‰è£æ•™å­¸", content: `<div class="tut-step"><strong>1. é–‹å•Ÿæª”æ¡ˆï¼š</strong><br>å‹™å¿…ä½¿ç”¨ <strong>Chrome</strong>ã€‚</div><div class="tut-step"><strong>2. é–‹å•Ÿé¸å–®ï¼š</strong><br>é»æ“Šå³ä¸Šè§’ <span style="font-size:1.2rem">â‹®</span>ã€‚</div><div class="tut-step"><strong>3. å®‰è£/åŠ å…¥ï¼š</strong><br>é¸æ“‡ <strong>ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€</strong> æˆ– <strong>ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€</strong>ã€‚</div>`, tp: null }
    ];

    let pMode = false;
    const contentArea = document.getElementById('contentArea');
    const searchInput = document.getElementById('searchInput');
    const fabBtn = document.getElementById('fabBtn');
    let userApiKey = localStorage.getItem('gemini_api_key') || "";

    function renderCards(filter = 'all', search = '') {
        if (filter === 'ai') { renderChatUI(); return; }
        contentArea.innerHTML = '';
        const filtered = protocols.filter(item => {
            const matchesCat = filter === 'all' ? true : item.cat === filter;
            const matchesSearch = item.title.toLowerCase().includes(search.toLowerCase()) || (item.key && item.key.some(k => k.toLowerCase().includes(search.toLowerCase())));
            const matchesP = pMode ? (item.tp !== null) : true;
            return matchesCat && matchesSearch && matchesP;
        });

        // TP Mode Sorting Logic (OHCA -> ACS -> Pulmonary Edema -> Asthma)
        if (pMode) {
            const priorityIds = ["Med-1", "Med-7", "Med-8", "Med-2"]; 
            filtered.sort((a, b) => {
                const idxA = priorityIds.indexOf(a.id);
                const idxB = priorityIds.indexOf(b.id);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return 0;
            });
        }

        if (filtered.length === 0) {
            contentArea.innerHTML = `<div style="text-align:center;color:#666;margin-top:60px;"><div style="font-size:3rem;margin-bottom:10px;">ğŸ¤”</div>æ²’æœ‰æ‰¾åˆ°ç›¸é—œæµç¨‹</div>`;
            return;
        }

        let html = '';
        filtered.forEach(item => {
            const isPHighlight = item.tp ? 'p-highlight' : '';
            const isTutHighlight = item.cat === 'tutorial' ? 'tut-highlight' : '';
            
            let flowHtml = '';
            if (item.flow && !pMode) { 
                flowHtml = '<div class="flow-container">';
                item.flow.forEach((step) => { flowHtml += `<div class="flow-step">${step}</div>`; });
                flowHtml += '</div>';
            }

            let bodyHtml = '';
            if (item.content) { 
                bodyHtml = item.content; 
            } else if (!pMode && item.key) {
                bodyHtml += '<div class="sec-header">âš¡ é—œéµè©•ä¼°èˆ‡è™•ç½®</div><ul>';
                item.key.forEach(k => { bodyHtml += `<li><span class="long-text">${k}</span></li>`; });
                bodyHtml += '</ul>';
            }

            let tpHtml = '';
            if (item.tp) {
                tpHtml += `<div class="drug-box"><div class="drug-title"><span class="tp-badge">TP</span> ${item.tp.action || "é«˜ç´šæ•‘è­·è™•ç½®"}</div>${item.tp.desc ? `<p>${item.tp.desc}</p>` : ''}`;
                if (item.tp.drugs) {
                    item.tp.drugs.forEach(d => {
                        tpHtml += `<div class="drug-card"><div style="font-weight:bold;color:#fff;margin-bottom:8px;font-size:1rem;">ğŸ’Š ${d.name}</div><div class="info-row"><div class="info-label">åŠ‘é‡</div><div class="info-val">${d.dose}</div></div><div class="info-row"><div class="info-label">é©æ‡‰ç—‡</div><div class="info-val success">${d.ind}</div></div><div class="info-row"><div class="info-label">è­¦ç¤º</div><div class="info-val danger">${d.warn}</div></div></div>`;
                    });
                }
                tpHtml += `</div>`;
            }

            const expandedClass = pMode ? 'expanded' : '';

            html += `<div class="card ${isPHighlight} ${isTutHighlight} ${expandedClass}" onclick="toggleCard(this)"><div class="card-header"><div>${item.id ? `<span class="card-id">${item.id}</span>` : ''}<span class="card-title">${item.title}</span></div><div class="expand-icon">â–¼</div></div><div class="card-body">${!pMode && item.cat !== 'tutorial' && !item.content ? '<div class="sec-header">ğŸ“‹ æ¨™æº–æµç¨‹</div>' : ''}${flowHtml}${bodyHtml}${tpHtml}</div></div>`;
        });
        contentArea.innerHTML = html;
    }

    function renderChatUI() {
        contentArea.innerHTML = `
            <div class="chat-wrapper">
                <div class="api-config-btn" onclick="configureAPI()">âš™ï¸ è¨­å®š</div>
                <div class="chat-messages" id="chatBox">
                    <div class="message msg-ai">
                        ğŸ‘‹ å—¨ï¼æˆ‘æ˜¯æ‚¨çš„ EMT æ™ºèƒ½åŠ©æ‰‹ã€‚<br>
                        è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨ï¼Ÿ<br>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="chat-mic-btn" onclick="startVoiceInput()" id="micBtn">ğŸ¤</button>
                    <button class="chat-send-btn" onclick="sendMessage()">â¤</button>
                </div>
            </div>
        `;
    }

    function configureAPI() {
        const key = prompt("è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key:\n(å…è²»ç”³è«‹ï¼šaistudio.google.com)", userApiKey);
        if (key !== null) {
            userApiKey = key;
            localStorage.setItem('gemini_api_key', key);
            alert("API Key å·²å„²å­˜ï¼");
        }
    }

    // Voice Input Function
    function startVoiceInput() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ (å»ºè­°ä½¿ç”¨ Chrome)");
            return;
        }
        
        const micBtn = document.getElementById('micBtn');
        const recognition = new webkitSpeechRecognition();
        
        recognition.lang = 'zh-TW'; // è¨­å®šèªè¨€ç‚ºç¹é«”ä¸­æ–‡
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = function() {
            micBtn.classList.add('listening');
            document.getElementById('chatInput').placeholder = "è«‹èªªè©±...";
        };

        recognition.onend = function() {
            micBtn.classList.remove('listening');
            document.getElementById('chatInput').placeholder = "è¼¸å…¥å•é¡Œ...";
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('chatInput').value = transcript;
        };

        recognition.start();
    }

    async function sendMessage(overrideText = null) {
        if (!navigator.onLine) { alert("âŒ ç„¡ç¶²è·¯é€£ç·šï¼Œç„¡æ³•ä½¿ç”¨ AI åŠŸèƒ½ã€‚"); return; }
        if (!userApiKey) { alert("âš ï¸ è«‹å…ˆè¨­å®š API Key"); configureAPI(); return; }

        const inputEl = document.getElementById('chatInput');
        const text = overrideText || inputEl.value.trim();
        if (!text) return;

        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="message msg-user">${text}</div>`;
        if (!overrideText) inputEl.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        const loadingId = 'loading-' + Date.now();
        chatBox.innerHTML += `<div class="message msg-ai" id="${loadingId}"><span class="typing-indicator"></span></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        const protocolContext = JSON.stringify(protocols);
        const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ EMT æ•‘è­·åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹ JSON æ ¼å¼çš„æ¡ƒåœ’æ¶ˆé˜²å±€æ¨™æº–æµç¨‹å›ç­”å•é¡Œã€‚
        æµç¨‹è³‡æ–™ï¼š${protocolContext}
        å›ç­”åŸå‰‡ï¼š
        1. å„ªå…ˆä½¿ç”¨è³‡æ–™ä¸­çš„å…§å®¹ã€‚
        2. ç°¡æ½”ã€æ¢åˆ—å¼ã€‚
        3. å›ç­”çµå°¾è«‹åŠ ä¸ŠæŒ‰éˆ• HTMLï¼š<br><button class="db-btn" onclick="triggerDatabaseQuery('${text}')">ğŸ“š èª¿é–±è³‡æ–™åº« (æŸ¥è©¢ PDF å…§å®¹)</button>
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: systemPrompt + "\n\nä½¿ç”¨è€…å•é¡Œï¼š" + text }] }] })
            });

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            document.getElementById(loadingId).innerHTML = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
            document.getElementById(loadingId).innerHTML = "âš ï¸ é€£ç·šéŒ¯èª¤ã€‚";
        }
    }

    // Two-Stage Query: Stage 2 uses Custom KB
    window.triggerDatabaseQuery = async function(originalQuery) {
        if (!navigator.onLine) { alert("ç„¡ç¶²è·¯é€£ç·š"); return; }
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="message msg-user">ğŸ“š æ­£åœ¨èª¿é–±è³‡æ–™åº«...<br><small>(é‡å°ï¼š${originalQuery})</small></div>`;
        const loadingId = 'loading-' + Date.now();
        chatBox.innerHTML += `<div class="message msg-ai" id="${loadingId}"><span class="typing-indicator"></span></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        const deepPrompt = `
        ä½¿ç”¨è€…å•é¡Œï¼šã€Œ${originalQuery}ã€ã€‚
        è«‹å¿½ç•¥ä¹‹å‰çš„å°è©±ï¼Œ**åš´æ ¼ä¸”åƒ…æ ¹æ“š**ä»¥ä¸‹ã€è³‡æ–™åº«å…§å®¹ã€‘ä¾†å›ç­”ï¼Œè‹¥è³‡æ–™åº«ç„¡ç›¸é—œè³‡è¨Šè«‹ç›´èªªã€‚
        
        ã€è³‡æ–™åº«å…§å®¹ã€‘ï¼š
        ${custom_kb}
        
        å›ç­”è¦æ±‚ï¼š
        1. å¼•ç”¨è³‡æ–™åº«ä¸­çš„å…·é«”æ•¸æ“šæˆ–è¦ç¯„ã€‚
        2. èªæ°£å°ˆæ¥­ã€‚
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: deepPrompt }] }] })
            });

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            document.getElementById(loadingId).innerHTML = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (e) { document.getElementById(loadingId).innerHTML = "æŸ¥è©¢å¤±æ•—ã€‚"; }
    };

    function toggleCard(el) { el.classList.toggle('expanded'); }
    function filterCat(cat) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        const targetBtn = document.querySelector(`.tab-btn[onclick="filterCat('${cat}')"]`);
        if(targetBtn) targetBtn.classList.add('active');
        if (pMode) document.querySelector('.tab-btn.p-mode').classList.add('active');
        renderCards(cat, searchInput.value);
    }
    function togglePMode() {
        pMode = !pMode;
        const btn = document.querySelector('.tab-btn.p-mode');
        if (pMode) {
            btn.classList.add('active');
            fabBtn.style.border = "4px solid #fff"; fabBtn.style.boxShadow = "0 0 20px var(--accent-p)"; fabBtn.innerHTML = "é€€å‡º"; fabBtn.style.background = "#b45309"; fabBtn.style.color = "white";
        } else {
            btn.classList.remove('active');
            fabBtn.style.border = "4px solid rgba(255,255,255,0.15)"; fabBtn.style.boxShadow = "0 4px 20px rgba(0,0,0,0.5)"; fabBtn.innerHTML = "TP<span>æ¨¡å¼</span>"; fabBtn.style.background = "var(--accent-p)"; fabBtn.style.color = "black";
        }
        const activeCatBtn = document.querySelector('.tab-btn.active:not(.p-mode)');
        const cat = activeCatBtn ? activeCatBtn.getAttribute('onclick').match(/'(.*)'/)[1] : 'all';
        renderCards(cat, searchInput.value);
    }
    searchInput.addEventListener('input', (e) => {
        const activeCatBtn = document.querySelector('.tab-btn.active:not(.p-mode)');
        const cat = activeCatBtn ? activeCatBtn.getAttribute('onclick').match(/'(.*)'/)[1] : 'all';
        renderCards(cat, e.target.value);
    });

    renderCards();
</script>
</body>
</html>
